from jinja2.runtime import LoopContext, Macro, Markup, Namespace, TemplateNotFound, TemplateReference, TemplateRuntimeError, Undefined, escape, identity, internalcode, markup_join, missing, str_join
name = 'tmpl_c79d0c9d7c5ee3c0cfd2ed005a0a9c235a829017.py'

def root(context, missing=missing):
    resolve = context.resolve_or_missing
    undefined = environment.undefined
    concat = environment.concat
    cond_expr_undefined = Undefined
    if 0: yield None
    pass
    yield 'from jinja2.runtime import LoopContext, Macro, Markup, Namespace, TemplateNotFound, TemplateReference, TemplateRuntimeError, Undefined, escape, identity, internalcode, markup_join, missing, str_join\nname = \'tmpl_f6013a00b362253c64368d6eebc50ea2131754e2.py\'\n\ndef root(context, missing=missing):\n    resolve = context.resolve_or_missing\n    undefined = environment.undefined\n    concat = environment.concat\n    cond_expr_undefined = Undefined\n    if 0: yield None\n    pass\n    yield \'from jinja2.runtime import LoopContext, Macro, Markup, Namespace, TemplateNotFound, TemplateReference, TemplateRuntimeError, Undefined, escape, identity, internalcode, markup_join, missing, str_join\\nname = \\\'index.html\\\'\\n\\ndef root(context, missing=missing):\\n    resolve = context.resolve_or_missing\\n    undefined = environment.undefined\\n    concat = environment.concat\\n    cond_expr_undefined = Undefined\\n    if 0: yield None\\n    l_0_session = resolve(\\\'session\\\')\\n    l_0_user = missing\\n    pass\\n    yield \\\'<!DOCTYPE html>\\\\n<html lang="en">\\\\n<head>\\\\n    <meta charset="UTF-8">\\\\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\\\\n    <title>ES Gamma Analyzer - 0DTE</title>\\\\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">\\\\n    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">\\\\n    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>\\\\n    <style>\\\\n        body {\\\\n            background: #0d1b2a;\\\\n            color: #f8f9fa;\\\\n            min-height: 100vh;\\\\n        }\\\\n        \\\\n        .navbar {\\\\n            background: linear-gradient(135deg, #1b263b 0%, #415a77 100%);\\\\n            border-bottom: 2px solid #778da9;\\\\n        }\\\\n        \\\\n        .navbar-brand {\\\\n            font-size: 1.8rem;\\\\n            font-weight: 700;\\\\n            color: #ffffff;\\\\n        }\\\\n        \\\\n        .upload-card {\\\\n            background: #1b263b;\\\\n            border: 2px solid #415a77;\\\\n            box-shadow: 0 4px 20px rgba(0,0,0,0.5);\\\\n        }\\\\n\\\\n        /* Compact top upload/regime section */\\\\n        .upload-card .card-body {\\\\n            padding: 0.5rem;\\\\n        }\\\\n\\\\n        .upload-card .upload-area {\\\\n            padding: 0.5rem !important;\\\\n            border-radius: 10px;\\\\n        }\\\\n\\\\n        .upload-card .upload-area .bi {\\\\n            font-size: 1.5rem !important;\\\\n        }\\\\n\\\\n        .upload-card .btn.btn-primary {\\\\n            padding: 0.2rem 0.6rem;\\\\n            font-size: 0.85rem;\\\\n        }\\\\n\\\\n        #esKeyLevelsCard #regimeCard .alert {\\\\n            padding: 0.4rem 0.6rem;\\\\n        }\\\\n\\\\n        /* Compact ES Key Levels (move details to hover tooltips) */\\\\n        #esKeyLevelsCard .price-box {\\\\n            padding: 0.45rem 0.65rem;\\\\n        }\\\\n\\\\n        #esKeyLevelsCard .price-box .fw-bold {\\\\n            font-size: 1.15rem;\\\\n            line-height: 1.05;\\\\n        }\\\\n\\\\n        #esKeyLevelsCard #esLiveTime {\\\\n            display: none;\\\\n        }\\\\n\\\\n        #esKeyLevelsCard #gammaFlipBox .box-sub {\\\\n            display: none;\\\\n        }\\\\n\\\\n        #esKeyLevelsCard .level-item {\\\\n            padding: 0.45rem 0.6rem;\\\\n            margin-bottom: 0.4rem;\\\\n            cursor: help;\\\\n        }\\\\n\\\\n        #esKeyLevelsCard .level-item .fw-bold {\\\\n            font-size: 0.95rem !important;\\\\n            line-height: 1.1;\\\\n            white-space: nowrap;\\\\n        }\\\\n\\\\n        #esKeyLevelsCard #esLiveBox,\\\\n        #esKeyLevelsCard #gammaFlipBox {\\\\n            cursor: help;\\\\n        }\\\\n\\\\n        /* Compact Market Pressure panel to free space for chart */\\\\n        #pressureCard .card-body {\\\\n            padding: 0.6rem;\\\\n        }\\\\n\\\\n        #pressureCard .price-box {\\\\n            padding: 0.45rem 0.65rem;\\\\n            border-radius: 10px;\\\\n        }\\\\n\\\\n        #pressureCard .pressure-instrument-box {\\\\n            padding: 0.35rem 0.55rem;\\\\n        }\\\\n\\\\n        #pressureCard .pressure-instrument-box .box-sub {\\\\n            display: none;\\\\n        }\\\\n\\\\n        #pressureCard .pressure-inline-meta {\\\\n            color: #adb5bd;\\\\n            font-weight: 500;\\\\n            font-size: 0.78rem;\\\\n            margin-left: 0.35rem;\\\\n            white-space: nowrap;\\\\n        }\\\\n\\\\n        #pressureCard .box-label {\\\\n            font-size: 0.8rem;\\\\n            line-height: 1.1;\\\\n            margin-bottom: 0.1rem;\\\\n        }\\\\n\\\\n        #pressureCard .fw-bold {\\\\n            font-size: 1.05rem;\\\\n            line-height: 1.05;\\\\n        }\\\\n\\\\n        #pressureCard .box-sub {\\\\n            font-size: 0.75rem;\\\\n            line-height: 1.1;\\\\n        }\\\\n\\\\n        #pressureCard #overallPressureTime {\\\\n            display: none;\\\\n        }\\\\n\\\\n        #pressureCard #overallPressureValue {\\\\n            font-size: 1.25rem;\\\\n        }\\\\n        \\\\n        .upload-area {\\\\n            border: 2px dashed #778da9;\\\\n            border-radius: 10px;\\\\n            padding: 3rem;\\\\n            background: rgba(119, 141, 169, 0.1);\\\\n            cursor: pointer;\\\\n            transition: all 0.3s;\\\\n        }\\\\n        \\\\n        .upload-area:hover {\\\\n            background: rgba(119, 141, 169, 0.2);\\\\n            border-color: #e0e1dd;\\\\n        }\\\\n        \\\\n        .upload-area.dragover {\\\\n            background: rgba(119, 141, 169, 0.25);\\\\n        }\\\\n        \\\\n        .btn-primary {\\\\n            background: linear-gradient(135deg, #415a77 0%, #778da9 100%);\\\\n            border: none;\\\\n            color: #ffffff;\\\\n            font-weight: 600;\\\\n            box-shadow: 0 4px 15px rgba(119, 141, 169, 0.4);\\\\n        }\\\\n        \\\\n        .btn-primary:hover {\\\\n            background: linear-gradient(135deg, #778da9 0%, #e0e1dd 100%);\\\\n            transform: translateY(-2px);\\\\n            box-shadow: 0 6px 20px rgba(119, 141, 169, 0.6);\\\\n        }\\\\n        \\\\n        .form-control {\\\\n            background: #0d1b2a;\\\\n            border: 2px solid #415a77;\\\\n            color: #f8f9fa;\\\\n        }\\\\n        \\\\n        .form-control:focus {\\\\n            background: #0d1b2a;\\\\n            border-color: #e0e1dd;\\\\n            color: #f8f9fa;\\\\n            box-shadow: 0 0 0 0.25rem rgba(224, 225, 221, 0.25);\\\\n        }\\\\n        \\\\n        .card {\\\\n            background: #1b263b;\\\\n            border: 2px solid #415a77;\\\\n        }\\\\n        \\\\n        .card-header {\\\\n            background: #415a77;\\\\n            border-bottom: 2px solid #778da9;\\\\n            font-weight: 600;\\\\n            color: #ffffff;\\\\n        }\\\\n        \\\\n        .gamma-flip-card {\\\\n            background: linear-gradient(135deg, #415a77 0%, #778da9 100%);\\\\n            border: 2px solid #e0e1dd;\\\\n        }\\\\n        \\\\n        .gamma-value {\\\\n            font-size: 3rem;\\\\n            font-weight: bold;\\\\n            color: #ffffff;\\\\n        }\\\\n        \\\\n        .level-item {\\\\n            background: #0d1b2a;\\\\n            border-radius: 10px;\\\\n            padding: 0.75rem;\\\\n            margin-bottom: 0.6rem;\\\\n            border-left: 4px solid;\\\\n            border: 2px solid;\\\\n            transition: all 0.3s;\\\\n            position: relative;\\\\n        }\\\\n\\\\n        /* Smaller text in the 3-column levels grid to avoid wrapping */\\\\n        #levelsRow .level-item .fw-bold.text-support.fs-5,\\\\n        #levelsRow .level-item .fw-bold.text-resistance.fs-5 {\\\\n            font-size: 1.05rem !important;\\\\n            line-height: 1.15;\\\\n            white-space: nowrap;\\\\n        }\\\\n\\\\n        #levelsRow .level-item .text-muted.small {\\\\n            font-size: 0.72rem;\\\\n            line-height: 1.15;\\\\n            white-space: nowrap;\\\\n        }\\\\n\\\\n        #levelsRow .level-item .level-metric {\\\\n            font-size: 1.00rem !important;\\\\n            white-space: normal;\\\\n            flex: 0 0 100%;\\\\n            text-align: right;\\\\n            margin-top: 0.25rem;\\\\n        }\\\\n\\\\n        /* Allow the metric to drop to the next line (prevents overflow into other cards) */\\\\n        #levelsRow .level-item .level-row {\\\\n            flex-wrap: wrap;\\\\n            align-items: flex-start;\\\\n        }\\\\n        \\\\n        .level-item:hover {\\\\n            transform: translateX(5px);\\\\n            box-shadow: 0 4px 12px rgba(0,0,0,0.4);\\\\n        }\\\\n\\\\n        /* Heat scale (yellow -> orange -> red). Top levels are red. */\\\\n        .heat-1,\\\\n        .heat-2 {\\\\n            /* Most important: red */\\\\n            background: rgba(251, 113, 133, 0.20) !important;\\\\n            border-color: rgba(251, 113, 133, 0.80) !important;\\\\n            border-left-color: #fb7185 !important;\\\\n        }\\\\n\\\\n        .heat-1 {\\\\n            background: rgba(251, 113, 133, 0.26) !important;\\\\n            border-color: rgba(251, 113, 133, 0.90) !important;\\\\n        }\\\\n\\\\n        .heat-3 {\\\\n            /* Medium: orange */\\\\n            background: rgba(234, 179, 8, 0.18) !important;\\\\n            border-color: rgba(234, 179, 8, 0.70) !important;\\\\n            border-left-color: #eab308 !important;\\\\n        }\\\\n\\\\n        .heat-4 {\\\\n            /* Lower: yellow */\\\\n            background: rgba(250, 204, 21, 0.14) !important;\\\\n            border-color: rgba(250, 204, 21, 0.60) !important;\\\\n            border-left-color: #facc15 !important;\\\\n        }\\\\n\\\\n        /* Blinking signal when price is near a level */\\\\n        .near-level {\\\\n            animation: nearPulse 0.75s ease-in-out infinite;\\\\n            border-width: 3px !important;\\\\n            filter: saturate(1.15);\\\\n        }\\\\n\\\\n        .near-level::after {\\\\n            content: \\\\\\\'\\\\\\\';\\\\n            position: absolute;\\\\n            right: 10px;\\\\n            top: 50%;\\\\n            width: 10px;\\\\n            height: 10px;\\\\n            border-radius: 999px;\\\\n            transform: translateY(-50%);\\\\n            background: #fb7185;\\\\n            box-shadow: 0 0 0 rgba(251, 113, 133, 0);\\\\n            animation: nearDot 0.75s ease-in-out infinite;\\\\n        }\\\\n\\\\n        @keyframes nearPulse {\\\\n            0%, 100% {\\\\n                box-shadow:\\\\n                    0 0 0 rgba(251, 113, 133, 0),\\\\n                    inset 0 0 0 rgba(251, 113, 133, 0);\\\\n                transform: translateX(0) scale(1);\\\\n                background-color: rgba(251, 113, 133, 0.00);\\\\n            }\\\\n            50% {\\\\n                box-shadow:\\\\n                    0 0 26px rgba(251, 113, 133, 0.85),\\\\n                    0 0 55px rgba(234, 179, 8, 0.35),\\\\n                    inset 0 0 0 2px rgba(251, 113, 133, 0.55);\\\\n                transform: translateX(6px) scale(1.01);\\\\n                background-color: rgba(251, 113, 133, 0.08);\\\\n            }\\\\n        }\\\\n\\\\n        @keyframes nearDot {\\\\n            0%, 100% {\\\\n                opacity: 0.45;\\\\n                box-shadow: 0 0 0 0 rgba(251, 113, 133, 0);\\\\n            }\\\\n            50% {\\\\n                opacity: 1;\\\\n                box-shadow: 0 0 0 10px rgba(251, 113, 133, 0.25);\\\\n            }\\\\n        }\\\\n\\\\n        @media (prefers-reduced-motion: reduce) {\\\\n            .near-level {\\\\n                animation: none;\\\\n                transform: none;\\\\n                box-shadow: 0 0 0 3px rgba(251, 113, 133, 0.65) !important;\\\\n            }\\\\n\\\\n            .near-level::after {\\\\n                animation: none;\\\\n                opacity: 1;\\\\n                box-shadow: none;\\\\n            }\\\\n        }\\\\n        \\\\n        .support-item {\\\\n            border-left-color: #2dd4bf;\\\\n            border-color: rgba(45, 212, 191, 0.4);\\\\n            background: rgba(45, 212, 191, 0.08);\\\\n        }\\\\n        \\\\n        .resistance-item {\\\\n            border-left-color: #fb7185;\\\\n            border-color: rgba(251, 113, 133, 0.4);\\\\n            background: rgba(251, 113, 133, 0.08);\\\\n        }\\\\n        \\\\n        .text-support {\\\\n            color: #2dd4bf;\\\\n            font-weight: 600;\\\\n        }\\\\n        \\\\n        .text-resistance {\\\\n            color: #fb7185;\\\\n            font-weight: 600;\\\\n        }\\\\n        \\\\n        .stat-card {\\\\n            background: #f8f9fa;\\\\n            border-left: 4px solid #778da9;\\\\n            border-radius: 10px;\\\\n            border: 2px solid #dee2e6;\\\\n        }\\\\n        \\\\n        .stat-card .text-muted {\\\\n            color: #495057 !important;\\\\n            font-weight: 500;\\\\n        }\\\\n        \\\\n        .stat-card .fs-3,\\\\n        .stat-card .fs-5 {\\\\n            color: #212529;\\\\n            font-weight: 700;\\\\n        }\\\\n        \\\\n        .spinner-border {\\\\n            color: #e0e1dd;\\\\n        }\\\\n        \\\\n        .text-muted {\\\\n            color: #adb5bd !important;\\\\n        }\\\\n        \\\\n        h5, h6 {\\\\n            color: #f8f9fa;\\\\n        }\\\\n        \\\\n        .alert-danger {\\\\n            background: rgba(251, 113, 133, 0.15);\\\\n            border: 2px solid #fb7185;\\\\n            color: #f8f9fa;\\\\n        }\\\\n        \\\\n        .alert-warning {\\\\n            background: rgba(250, 204, 21, 0.15);\\\\n            border: 2px solid #facc15;\\\\n            color: #f8f9fa;\\\\n        }\\\\n\\\\n        .price-box {\\\\n            background: #0d1b2a;\\\\n            border: 2px solid #415a77;\\\\n            border-radius: 10px;\\\\n            padding: 0.75rem 1rem;\\\\n            color: #f8f9fa;\\\\n        }\\\\n\\\\n        .pressure-buy {\\\\n            border-color: rgba(45, 212, 191, 0.85) !important;\\\\n            background: rgba(45, 212, 191, 0.08) !important;\\\\n        }\\\\n\\\\n        .pressure-sell {\\\\n            border-color: rgba(251, 113, 133, 0.85) !important;\\\\n            background: rgba(251, 113, 133, 0.08) !important;\\\\n        }\\\\n\\\\n        .price-box * {\\\\n            color: #f8f9fa !important;\\\\n        }\\\\n\\\\n        /* Tighter typography so ES/NVDA/SPY fit without line breaks */\\\\n        #levelsRow .card-header {\\\\n            font-size: 0.95rem;\\\\n        }\\\\n\\\\n        #levelsRow .box-label {\\\\n            font-size: 0.78rem;\\\\n        }\\\\n\\\\n        #levelsRow .box-sub {\\\\n            font-size: 0.75rem;\\\\n        }\\\\n\\\\n        #levelsRow .price-box .fw-bold {\\\\n            font-size: 1.15rem;\\\\n            line-height: 1.1;\\\\n        }\\\\n\\\\n        #levelsRow h6.text-support,\\\\n        #levelsRow h6.text-resistance {\\\\n            font-size: 0.90rem;\\\\n            white-space: nowrap;\\\\n        }\\\\n\\\\n        #levelsRow p.text-muted.small {\\\\n            font-size: 0.72rem;\\\\n            white-space: nowrap;\\\\n            margin-bottom: 0.35rem;\\\\n        }\\\\n\\\\n        #nvdaExpiryLabel,\\\\n        #spyExpiryLabel,\\\\n        #msftExpiryLabel,\\\\n        #spxExpiryLabel,\\\\n        #xspExpiryLabel {\\\\n            font-size: 0.75rem;\\\\n            white-space: nowrap;\\\\n        }\\\\n\\\\n        /* Analyze is now automatic on upload */\\\\n        #analyzeBtn {\\\\n            display: none;\\\\n        }\\\\n\\\\n        .box-label {\\\\n            font-size: 0.875rem;\\\\n            font-weight: 600;\\\\n            line-height: 1.2;\\\\n        }\\\\n\\\\n        .box-sub {\\\\n            font-size: 0.875rem;\\\\n            font-weight: 500;\\\\n            line-height: 1.2;\\\\n            opacity: 0.9;\\\\n        }\\\\n\\\\n        .current-price-card {\\\\n            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%) !important;\\\\n            border-left-color: #8b5cf6 !important;\\\\n        }\\\\n\\\\n        .current-price-card .text-muted,\\\\n        .current-price-card .fs-3,\\\\n        .current-price-card .fs-5 {\\\\n            color: #f8f9fa !important;\\\\n        }\\\\n\\\\n        /* Mobile responsiveness helpers */\\\\n        .price-row {\\\\n            /* Uses Bootstrap .row/.col-* for layout */\\\\n            align-items: stretch;\\\\n        }\\\\n\\\\n        .price-box {\\\\n            width: 100%;\\\\n            min-width: 0;\\\\n        }\\\\n\\\\n        .min-w-0 {\\\\n            min-width: 0;\\\\n        }\\\\n\\\\n        .filename-truncate {\\\\n            max-width: 250px;\\\\n        }\\\\n\\\\n        @media (max-width: 575.98px) {\\\\n            .navbar .container {\\\\n                display: flex;\\\\n                flex-direction: column;\\\\n                align-items: flex-start;\\\\n                gap: 0.25rem;\\\\n            }\\\\n\\\\n            .navbar-brand {\\\\n                font-size: 1.25rem;\\\\n            }\\\\n\\\\n            .upload-area {\\\\n                padding: 1rem !important;\\\\n            }\\\\n\\\\n            .price-row {\\\\n                justify-content: flex-start;\\\\n            }\\\\n\\\\n            .price-box {\\\\n                width: 100%;\\\\n            }\\\\n\\\\n            .filename-truncate {\\\\n                max-width: 180px;\\\\n            }\\\\n\\\\n            .level-item .level-row {\\\\n                flex-direction: column;\\\\n                align-items: flex-start !important;\\\\n                gap: 0.5rem;\\\\n            }\\\\n\\\\n            .level-item .level-metric {\\\\n                align-self: flex-end;\\\\n            }\\\\n        }\\\\n    </style>\\\\n</head>\\\\n<body>\\\\n    <nav class="navbar mb-4">\\\\n        <div class="container-fluid px-2 px-lg-3">\\\\n            <div class="d-flex align-items-center justify-content-between w-100">\\\\n                <span class="navbar-brand">ES Gamma Analyzer</span>\\\\n\\\\n                <div class="d-flex align-items-center gap-3">\\\\n                    <span class="text-muted">0DTE Analysis</span>\\\\n\\\\n                    \\\'\\n    l_0_user = context.call(environment.getattr((undefined(name=\\\'session\\\') if l_0_session is missing else l_0_session), \\\'get\\\'), \\\'user\\\')\\n    context.vars[\\\'user\\\'] = l_0_user\\n    context.exported_vars.add(\\\'user\\\')\\n    yield \\\'\\\\n                    \\\'\\n    if (undefined(name=\\\'user\\\') if l_0_user is missing else l_0_user):\\n        pass\\n        yield \\\'\\\\n                        <div class="dropdown">\\\\n                            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">\\\\n                                \\\'\\n        yield escape(((context.call(environment.getattr((undefined(name=\\\'user\\\') if l_0_user is missing else l_0_user), \\\'get\\\'), \\\'name\\\') or context.call(environment.getattr((undefined(name=\\\'user\\\') if l_0_user is missing else l_0_user), \\\'get\\\'), \\\'email\\\')) or \\\'Account\\\'))\\n        yield \\\'\\\\n                            </button>\\\\n                            <ul class="dropdown-menu dropdown-menu-end" style="background: #1b263b; border: 2px solid #415a77;">\\\\n                                \\\'\\n        if context.call(environment.getattr((undefined(name=\\\'user\\\') if l_0_user is missing else l_0_user), \\\'get\\\'), \\\'email\\\'):\\n            pass\\n            yield \\\'\\\\n                                    <li>\\\\n                                        <span class="dropdown-item-text" style="color:#adb5bd;">\\\\n                                            \\\'\\n            yield escape(context.call(environment.getattr((undefined(name=\\\'user\\\') if l_0_user is missing else l_0_user), \\\'get\\\'), \\\'email\\\'))\\n            yield \\\'\\\\n                                        </span>\\\\n                                    </li>\\\\n                                    <li><hr class="dropdown-divider" style="border-color:#415a77;"></li>\\\\n                                \\\'\\n        yield \\\'\\\\n                                <li><a class="dropdown-item" href="/logout" style="color:#f8f9fa;">Logout</a></li>\\\\n                            </ul>\\\\n                        </div>\\\\n                    \\\'\\n    yield \\\'\\\\n                </div>\\\\n            </div>\\\\n        </div>\\\\n    </nav>\\\\n    \\\\n    <div class="container-fluid px-2 px-lg-3">\\\\n        <!-- Upload Section -->\\\\n        <div class="card upload-card mb-2">\\\\n            <div class="card-body">\\\\n                <div class="row align-items-center">\\\\n                    <div class="col-md-5">\\\\n                        <div class="upload-area" id="uploadArea" style="cursor: pointer;">\\\\n                            <div class="d-flex align-items-center">\\\\n                                <i class="bi bi-file-earmark-pdf me-3" style="color: #778da9;"></i>\\\\n                                <div>\\\\n                                    <div class="fw-semibold small mb-0">Upload PDF</div>\\\\n                                    <div class="text-muted small mb-0">Click or drag and drop</div>\\\\n                                </div>\\\\n                            </div>\\\\n                            <input type="file" id="fileInput" accept=".pdf" style="display: none;">\\\\n                        </div>\\\\n                    </div>\\\\n                    \\\\n                    <div class="col-md-7 text-md-end text-start mt-3 mt-md-0">\\\\n                        <button class="btn btn-primary btn-sm" id="analyzeBtn" disabled>\\\\n                            <i class="bi bi-graph-up me-2"></i>Analyze\\\\n                        </button>\\\\n                    </div>\\\\n                </div>\\\\n                \\\\n                <div class="alert alert-danger mt-3" id="errorMsg" style="display: none;"></div>\\\\n                \\\\n                <div class="text-center mt-2" id="loading" style="display: none;">\\\\n                    <div class="spinner-border" role="status">\\\\n                        <span class="visually-hidden">Loading...</span>\\\\n                    </div>\\\\n                    <p class="mt-3 fw-bold" style="color: #3b82f6;">Analysis in progress...</p>\\\\n                </div>\\\\n            </div>\\\\n        </div>\\\\n\\\\n        <!-- Levels Row: ES/SPX/SPY/XSP + NVDA/MSFT -->\\\\n        <div class="row g-2 mb-4" id="levelsRow">\\\\n            <!-- Row 1: ES + SPX + SPY + XSP -->\\\\n            <div class="col-12">\\\\n                <div class="row g-2">\\\\n                    <div class="col-12 col-md-3">\\\\n                        <div class="card" id="esKeyLevelsCard">\\\\n                            <div class="card-header">\\\\n                                <div class="d-flex align-items-center justify-content-between">\\\\n                                    <div>\\\\n                                        <i class="bi bi-bullseye me-2"></i>ES Key Levels <span class="text-muted" id="esPcrLabel"></span>\\\\n                                    </div>\\\\n                                    <div class="form-check form-switch mb-0" style="transform: scale(0.95); transform-origin: right center;">\\\\n                                        <input class="form-check-input" type="checkbox" role="switch" id="esLevelsModeSwitch">\\\\n                                        <label class="form-check-label small text-nowrap" for="esLevelsModeSwitch">Use current price</label>\\\\n                                    </div>\\\\n                                </div>\\\\n                            </div>\\\\n                            <div class="card-body">\\\\n                                <div class="row g-2 mb-3 price-row">\\\\n                                    <div class="col-6">\\\\n                                        <div class="price-box text-start" id="esLiveBox" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="--">\\\\n                                        <div class="box-label">ES live</div>\\\\n                                        <div class="fw-bold" id="esLivePrice">--</div>\\\\n                                        <div class="box-sub" id="esLiveTime">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n\\\\n                                    <div class="col-6">\\\\n                                        <div class="price-box text-start" id="gammaFlipBox" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="--">\\\\n                                        <div class="box-label">ES Gamma Flip</div>\\\\n                                        <div class="fw-bold" id="gammaFlipTop">--</div>\\\\n                                        <div class="box-sub">GAMMA FLIP LEVEL</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                </div>\\\\n\\\\n                                <div id="regimeCard" style="display: none;" class="mb-2">\\\\n                                    <div class="alert alert-warning mb-0" style="background: rgba(234, 179, 8, 0.1); border-left: 4px solid #eab308;">\\\\n                                        <div class="fw-semibold small mb-1" id="regimeType">-</div>\\\\n                                        <div class="small" id="regimeStrategy">-</div>\\\\n                                    </div>\\\\n                                </div>\\\\n\\\\n                                <div class="row">\\\\n                                    <div class="col-md-6">\\\\n                                        <h6 class="text-support mb-3">\\\\n                                            <i class="bi bi-shield-check me-2"></i>Top 3 PUT Supports\\\\n                                        </h6>\\\\n                                        <p class="text-muted small" id="esSupportsModeHint">Below gamma flip (highest Put OI)</p>\\\\n                                        <div id="supportsContainer">\\\\n                                            <p class="text-muted text-center py-3">No data</p>\\\\n                                        </div>\\\\n                                        <p id="supportsNote" class="text-warning mt-2 small" style="display: none;"></p>\\\\n                                    </div>\\\\n                                    <div class="col-md-6">\\\\n                                        <h6 class="text-resistance mb-3">\\\\n                                            <i class="bi bi-shield-x me-2"></i>Top 3 CALL Resistances\\\\n                                        </h6>\\\\n                                        <p class="text-muted small" id="esResistancesModeHint">Above gamma flip (highest Call OI)</p>\\\\n                                        <div id="resistancesContainer">\\\\n                                            <p class="text-muted text-center py-3">No data</p>\\\\n                                        </div>\\\\n                                        <p id="resistancesNote" class="text-warning mt-2 small" style="display: none;"></p>\\\\n                                    </div>\\\\n                                </div>\\\\n                            </div>\\\\n                        </div>\\\\n                    </div>\\\\n\\\\n                    <div class="col-12 col-md-9">\\\\n                        <div class="card" id="pressureCard">\\\\n                            <div class="card-header">\\\\n                                <div class="d-flex align-items-center justify-content-between">\\\\n                                    <div>\\\\n                                        <i class="bi bi-speedometer2 me-2"></i>Market Pressure (ES + SPX + SPY + XSP)\\\\n                                    </div>\\\\n                                    <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#pressureInfoModal" aria-label="Info pressure">\\\\n                                        <i class="bi bi-info-circle"></i>\\\\n                                    </button>\\\\n                                </div>\\\\n                            </div>\\\\n                            <div class="card-body">\\\\n                                <div class="row g-2 mb-2">\\\\n                                    <div class="col-12">\\\\n                                        <div class="price-box text-start" id="overallPressureBox">\\\\n                                            <div class="box-label">Overall <span class="pressure-inline-meta" id="overallPressureInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="overallPressureValue">--</div>\\\\n                                            <div class="box-sub" id="overallPressureTime">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                </div>\\\\n\\\\n                                <div class="row g-2">\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureEsBox">\\\\n                                            <div class="box-label">ES <span class="pressure-inline-meta" id="pressureEsInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureEsValue">--</div>\\\\n                                            <div class="box-sub" id="pressureEsMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureSpxBox">\\\\n                                            <div class="box-label">SPX <span class="pressure-inline-meta" id="pressureSpxInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureSpxValue">--</div>\\\\n                                            <div class="box-sub" id="pressureSpxMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureSpyBox">\\\\n                                            <div class="box-label">SPY <span class="pressure-inline-meta" id="pressureSpyInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureSpyValue">--</div>\\\\n                                            <div class="box-sub" id="pressureSpyMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureXspBox">\\\\n                                            <div class="box-label">XSP <span class="pressure-inline-meta" id="pressureXspInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureXspValue">--</div>\\\\n                                            <div class="box-sub" id="pressureXspMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureNvdaBox">\\\\n                                            <div class="box-label">NVDA <span class="pressure-inline-meta" id="pressureNvdaInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureNvdaValue">--</div>\\\\n                                            <div class="box-sub" id="pressureNvdaMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureMsftBox">\\\\n                                            <div class="box-label">MSFT <span class="pressure-inline-meta" id="pressureMsftInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureMsftValue">--</div>\\\\n                                            <div class="box-sub" id="pressureMsftMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureAaplBox">\\\\n                                            <div class="box-label">AAPL <span class="pressure-inline-meta" id="pressureAaplInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureAaplValue">--</div>\\\\n                                            <div class="box-sub" id="pressureAaplMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureGoogBox">\\\\n                                            <div class="box-label">GOOG <span class="pressure-inline-meta" id="pressureGoogInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureGoogValue">--</div>\\\\n                                            <div class="box-sub" id="pressureGoogMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                    <div class="col-6 col-lg-4">\\\\n                                        <div class="price-box text-start pressure-instrument-box" id="pressureAmznBox">\\\\n                                            <div class="box-label">AMZN <span class="pressure-inline-meta" id="pressureAmznInlineMeta"></span></div>\\\\n                                            <div class="fw-bold" id="pressureAmznValue">--</div>\\\\n                                            <div class="box-sub" id="pressureAmznMeta">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                </div>\\\\n\\\\n                                <div class="mt-2">\\\\n                                    <div class="d-flex align-items-center justify-content-between mb-2">\\\\n                                        <div class="text-muted small">Combined pressure (BUY=+1 / SELL=-1 per instrument)</div>\\\\n                                        <button type="button" class="btn btn-sm btn-outline-light" id="pressureChartResetBtn" aria-label="Reset chart view">\\\\n                                            <i class="bi bi-arrow-clockwise"></i>\\\\n                                        </button>\\\\n                                    </div>\\\\n                                    <div id="pressureChart" style="height: 220px;"></div>\\\\n                                </div>\\\\n\\\\n                                <div class="mt-3 text-muted small">\\\\n                                    Pressure is inferred from price change and gamma regime (above/below gamma flip).\\\\n                                </div>\\\\n                            </div>\\\\n                        </div>\\\\n                    </div>\\\\n                </div>\\\\n            </div>\\\\n\\\\n            <!-- Row 2: NVDA + MSFT -->\\\\n            <div class="col-12">\\\\n                <div class="row g-2">\\\\n                    <div class="col-12 col-md-6">\\\\n                        <div class="card" id="nvdaKeyLevelsCard">\\\\n                            <div class="card-header">\\\\n                                <div class="d-flex align-items-center justify-content-between">\\\\n                                    <div>\\\\n                                        <i class="bi bi-bullseye me-2"></i>NVDA Key Levels <span class="text-muted" id="nvdaExpiryLabel"></span> <span class="text-muted" id="nvdaPcrLabel"></span>\\\\n                                    </div>\\\\n                                    <div class="form-check form-switch mb-0" style="transform: scale(0.95); transform-origin: right center;">\\\\n                                        <input class="form-check-input" type="checkbox" role="switch" id="nvdaLevelsModeSwitch">\\\\n                                        <label class="form-check-label small text-nowrap" for="nvdaLevelsModeSwitch">Use current price</label>\\\\n                                    </div>\\\\n                                </div>\\\\n                            </div>\\\\n                            <div class="card-body">\\\\n                                <div class="row g-2 mb-3 price-row">\\\\n                                    <div class="col-6">\\\\n                                        <div class="price-box text-start" id="nvdaLiveBox">\\\\n                                        <div class="box-label">NVDA live</div>\\\\n                                        <div class="fw-bold" id="nvdaLivePrice">--</div>\\\\n                                        <div class="box-sub" id="nvdaLiveTime">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n\\\\n                                    <div class="col-6">\\\\n                                        <div class="price-box text-start" id="nvdaGammaFlipBox">\\\\n                                        <div class="box-label">NVDA Gamma Flip</div>\\\\n                                        <div class="fw-bold" id="nvdaGammaFlipTop">--</div>\\\\n                                        <div class="box-sub">GAMMA FLIP LEVEL</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                </div>\\\\n\\\\n                                <div class="row">\\\\n                                    <div class="col-md-6">\\\\n                                        <h6 class="text-support mb-3">\\\\n                                            <i class="bi bi-shield-check me-2"></i>Top 3 PUT Supports\\\\n                                        </h6>\\\\n                                        <p class="text-muted small" id="nvdaSupportsModeHint">Below gamma flip (highest Put OI)</p>\\\\n                                        <div id="nvdaSupportsContainer">\\\\n                                            <p class="text-muted text-center py-3">No data</p>\\\\n                                        </div>\\\\n                                        <p id="nvdaSupportsNote" class="text-warning mt-2 small" style="display: none;"></p>\\\\n                                    </div>\\\\n                                    <div class="col-md-6">\\\\n                                        <h6 class="text-resistance mb-3">\\\\n                                            <i class="bi bi-shield-x me-2"></i>Top 3 CALL Resistances\\\\n                                        </h6>\\\\n                                        <p class="text-muted small" id="nvdaResistancesModeHint">Above gamma flip (highest Call OI)</p>\\\\n                                        <div id="nvdaResistancesContainer">\\\\n                                            <p class="text-muted text-center py-3">No data</p>\\\\n                                        </div>\\\\n                                        <p id="nvdaResistancesNote" class="text-warning mt-2 small" style="display: none;"></p>\\\\n                                    </div>\\\\n                                </div>\\\\n                            </div>\\\\n                        </div>\\\\n                    </div>\\\\n\\\\n                    <div class="col-12 col-md-6">\\\\n                        <div class="card" id="msftKeyLevelsCard">\\\\n                            <div class="card-header">\\\\n                                <div class="d-flex align-items-center justify-content-between">\\\\n                                    <div>\\\\n                                        <i class="bi bi-bullseye me-2"></i>MSFT Key Levels <span class="text-muted" id="msftExpiryLabel"></span> <span class="text-muted" id="msftPcrLabel"></span>\\\\n                                    </div>\\\\n                                    <div class="form-check form-switch mb-0" style="transform: scale(0.95); transform-origin: right center;">\\\\n                                        <input class="form-check-input" type="checkbox" role="switch" id="msftLevelsModeSwitch">\\\\n                                        <label class="form-check-label small text-nowrap" for="msftLevelsModeSwitch">Use current price</label>\\\\n                                    </div>\\\\n                                </div>\\\\n                            </div>\\\\n                            <div class="card-body">\\\\n                                <div class="row g-2 mb-3 price-row">\\\\n                                    <div class="col-6">\\\\n                                        <div class="price-box text-start" id="msftLiveBox">\\\\n                                        <div class="box-label">MSFT live</div>\\\\n                                        <div class="fw-bold" id="msftLivePrice">--</div>\\\\n                                        <div class="box-sub" id="msftLiveTime">--</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n\\\\n                                    <div class="col-6">\\\\n                                        <div class="price-box text-start" id="msftGammaFlipBox">\\\\n                                        <div class="box-label">MSFT Gamma Flip</div>\\\\n                                        <div class="fw-bold" id="msftGammaFlipTop">--</div>\\\\n                                        <div class="box-sub">GAMMA FLIP LEVEL</div>\\\\n                                        </div>\\\\n                                    </div>\\\\n                                </div>\\\\n\\\\n                                <div class="row">\\\\n                                    <div class="col-md-6">\\\\n                                        <h6 class="text-support mb-3">\\\\n                                            <i class="bi bi-shield-check me-2"></i>Top 3 PUT Supports\\\\n                                        </h6>\\\\n                                        <p class="text-muted small" id="msftSupportsModeHint">Below gamma flip (highest Put OI)</p>\\\\n                                        <div id="msftSupportsContainer">\\\\n                                            <p class="text-muted text-center py-3">No data</p>\\\\n                                        </div>\\\\n                                        <p id="msftSupportsNote" class="text-warning mt-2 small" style="display: none;"></p>\\\\n                                    </div>\\\\n                                    <div class="col-md-6">\\\\n                                        <h6 class="text-resistance mb-3">\\\\n                                            <i class="bi bi-shield-x me-2"></i>Top 3 CALL Resistances\\\\n                                        </h6>\\\\n                                        <p class="text-muted small" id="msftResistancesModeHint">Above gamma flip (highest Call OI)</p>\\\\n                                        <div id="msftResistancesContainer">\\\\n                                            <p class="text-muted text-center py-3">No data</p>\\\\n                                        </div>\\\\n                                        <p id="msftResistancesNote" class="text-warning mt-2 small" style="display: none;"></p>\\\\n                                    </div>\\\\n                                </div>\\\\n                            </div>\\\\n                        </div>\\\\n                    </div>\\\\n                </div>\\\\n            </div>\\\\n        </div>\\\\n        \\\\n        <!-- Results Section -->\\\\n        <div id="results" style="display: none;">\\\\n            <div id="gammaFlipValue" style="display: none;"></div>\\\\n            \\\\n            <!-- Chart -->\\\\n            <!-- <div class="card mb-4">\\\\n                <div class="card-header">\\\\n                    <i class="bi bi-graph-up me-2"></i>ES Levels Chart\\\\n                </div>\\\\n                <div class="card-body" style="background: #ffffff;">\\\\n                    <div id="chart" style="height: 500px;"></div>\\\\n                </div>\\\\n            </div> -->\\\\n            \\\\n            <!-- (0DTE Statistics removed) -->\\\\n        </div>\\\\n    </div>\\\\n    \\\\n    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>\\\\n\\\\n    <!-- Pressure Info Modal -->\\\\n    <div class="modal fade" id="pressureInfoModal" tabindex="-1" aria-labelledby="pressureInfoModalLabel" aria-hidden="true">\\\\n        <div class="modal-dialog modal-lg modal-dialog-scrollable">\\\\n            <div class="modal-content" style="background: #1b263b; border: 2px solid #415a77;">\\\\n                <div class="modal-header" style="border-bottom: 2px solid #415a77;">\\\\n                    <h5 class="modal-title" id="pressureInfoModalLabel" style="color: #f8f9fa;">Come calcoliamo la pressure</h5>\\\\n                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>\\\\n                </div>\\\\n                <div class="modal-body" style="color: #f8f9fa;">\\\\n                    <p class="mb-3">Come sto calcolando la “pressure” adesso</p>\\\\n\\\\n                    <p class="mb-2">Per ogni strumento (ES, SPX, SPY, XSP) prendo il cambio di prezzo tra l’ultimo update e il precedente:</p>\\\\n                    <p class="mb-3"><code style="color:#f8f9fa;">Δ = price_now − price_prev</code></p>\\\\n\\\\n                    <p class="mb-2">Stimo il regime gamma usando il <code style="color:#f8f9fa;">gamma_flip</code>:</p>\\\\n                    <ul class="mb-3">\\\\n                        <li>se <code style="color:#f8f9fa;">price &gt;= gamma_flip</code> ⇒ Positive Gamma</li>\\\\n                        <li>se <code style="color:#f8f9fa;">price &lt; gamma_flip</code> ⇒ Negative Gamma</li>\\\\n                    </ul>\\\\n\\\\n                    <p class="mb-2">Poi trasformo <code style="color:#f8f9fa;">Δ</code> in BUY/SELL con la logica “dealer hedging” (versione semplificata):</p>\\\\n                    <ul class="mb-3">\\\\n                        <li>Positive Gamma (mean-reverting): se prezzo sale ⇒ SELL, se scende ⇒ BUY</li>\\\\n                        <li>Negative Gamma (trend): se prezzo sale ⇒ BUY, se scende ⇒ SELL</li>\\\\n                        <li>se non ho <code style="color:#f8f9fa;">gamma_flip</code> valido ⇒ fallback “momentum”: su ⇒ BUY, giù ⇒ SELL</li>\\\\n                    </ul>\\\\n\\\\n                    <p class="mb-3">L’Overall è la maggioranza tra i 4 (BUY vs SELL).</p>\\\\n\\\\n                    <p class="mb-3">Nota importante: questa è una proxy (non è HIRO). HIRO usa dati proprietari (flussi/hedging stimato). Qui stiamo inferendo un segnale con le info disponibili (prezzo + gamma flip).</p>\\\\n\\\\n                    <p class="mb-2">Grafico “stile HIRO”</p>\\\\n                    <p class="mb-2">Ho aggiunto un grafico nel box “Market Pressure” che mostra nel tempo un punteggio combinato:</p>\\\\n                    <ul class="mb-0">\\\\n                        <li>BUY = +1, SELL = -1 per strumento</li>\\\\n                        <li>score totale = somma (range da -4 a +4)</li>\\\\n                        <li>barre verdi se score ≥ 0, rosse se score &lt; 0</li>\\\\n                    </ul>\\\\n                </div>\\\\n                <div class="modal-footer" style="border-top: 2px solid #415a77;">\\\\n                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Chiudi</button>\\\\n                </div>\\\\n            </div>\\\\n        </div>\\\\n    </div>\\\\n\\\\n    <script>\\\\n        let selectedFile = null;\\\\n        let isAnalyzing = false;\\\\n        let esLoadPromise = null;\\\\n        let esPollIntervalId = null;\\\\n        let latestEsPrice = null;\\\\n        let latestEsGammaFlip = null;\\\\n        let prevEsPrice = null;\\\\n        let nvdaLoadPromise = null;\\\\n        let nvdaPollIntervalId = null;\\\\n        let latestNvdaPrice = null;\\\\n        let latestNvdaGammaFlip = null;\\\\n        let prevNvdaPrice = null;\\\\n        let spyLoadPromise = null;\\\\n        let spyPollIntervalId = null;\\\\n        let latestSpyPrice = null;\\\\n        let latestSpyGammaFlip = null;\\\\n        let prevSpyPrice = null;\\\\n        let msftLoadPromise = null;\\\\n        let msftPollIntervalId = null;\\\\n        let latestMsftPrice = null;\\\\n        let latestMsftGammaFlip = null;\\\\n        let prevMsftPrice = null;\\\\n        let spxLoadPromise = null;\\\\n        let spxPollIntervalId = null;\\\\n        let latestSpxPrice = null;\\\\n        let latestSpxGammaFlip = null;\\\\n        let prevSpxPrice = null;\\\\n        let xspLoadPromise = null;\\\\n        let xspPollIntervalId = null;\\\\n        let latestXspPrice = null;\\\\n        let latestXspGammaFlip = null;\\\\n        let prevXspPrice = null;\\\\n\\\\n        let aaplLoadPromise = null;\\\\n        let aaplPollIntervalId = null;\\\\n        let latestAaplPrice = null;\\\\n        let latestAaplGammaFlip = null;\\\\n        let prevAaplPrice = null;\\\\n\\\\n        let googLoadPromise = null;\\\\n        let googPollIntervalId = null;\\\\n        let latestGoogPrice = null;\\\\n        let latestGoogGammaFlip = null;\\\\n        let prevGoogPrice = null;\\\\n\\\\n        let amznLoadPromise = null;\\\\n        let amznPollIntervalId = null;\\\\n        let latestAmznPrice = null;\\\\n        let latestAmznGammaFlip = null;\\\\n        let prevAmznPrice = null;\\\\n        \\\\n        const uploadArea = document.getElementById(\\\\\\\'uploadArea\\\\\\\');\\\\n        const fileInput = document.getElementById(\\\\\\\'fileInput\\\\\\\');\\\\n        const analyzeBtn = document.getElementById(\\\\\\\'analyzeBtn\\\\\\\');\\\\n        const loading = document.getElementById(\\\\\\\'loading\\\\\\\');\\\\n        const results = document.getElementById(\\\\\\\'results\\\\\\\');\\\\n        const errorMsg = document.getElementById(\\\\\\\'errorMsg\\\\\\\');\\\\n        const esLivePrice = document.getElementById(\\\\\\\'esLivePrice\\\\\\\');\\\\n        const esLiveTime = document.getElementById(\\\\\\\'esLiveTime\\\\\\\');\\\\n        const esLiveBox = document.getElementById(\\\\\\\'esLiveBox\\\\\\\');\\\\n        const gammaFlipBox = document.getElementById(\\\\\\\'gammaFlipBox\\\\\\\');\\\\n        const gammaFlipTop = document.getElementById(\\\\\\\'gammaFlipTop\\\\\\\');\\\\n        const esLevelsModeSwitch = document.getElementById(\\\\\\\'esLevelsModeSwitch\\\\\\\');\\\\n        const esSupportsModeHint = document.getElementById(\\\\\\\'esSupportsModeHint\\\\\\\');\\\\n        const esResistancesModeHint = document.getElementById(\\\\\\\'esResistancesModeHint\\\\\\\');\\\\n        const nvdaLivePrice = document.getElementById(\\\\\\\'nvdaLivePrice\\\\\\\');\\\\n        const nvdaLiveTime = document.getElementById(\\\\\\\'nvdaLiveTime\\\\\\\');\\\\n        const nvdaGammaFlipTop = document.getElementById(\\\\\\\'nvdaGammaFlipTop\\\\\\\');\\\\n        const nvdaExpiryLabel = document.getElementById(\\\\\\\'nvdaExpiryLabel\\\\\\\');\\\\n        const nvdaLevelsModeSwitch = document.getElementById(\\\\\\\'nvdaLevelsModeSwitch\\\\\\\');\\\\n        const nvdaSupportsModeHint = document.getElementById(\\\\\\\'nvdaSupportsModeHint\\\\\\\');\\\\n        const nvdaResistancesModeHint = document.getElementById(\\\\\\\'nvdaResistancesModeHint\\\\\\\');\\\\n        const nvdaSupportsContainer = document.getElementById(\\\\\\\'nvdaSupportsContainer\\\\\\\');\\\\n        const nvdaSupportsNote = document.getElementById(\\\\\\\'nvdaSupportsNote\\\\\\\');\\\\n        const nvdaResistancesContainer = document.getElementById(\\\\\\\'nvdaResistancesContainer\\\\\\\');\\\\n        const nvdaResistancesNote = document.getElementById(\\\\\\\'nvdaResistancesNote\\\\\\\');\\\\n        const pressureEsValue = document.getElementById(\\\\\\\'pressureEsValue\\\\\\\');\\\\n        const pressureEsMeta = document.getElementById(\\\\\\\'pressureEsMeta\\\\\\\');\\\\n        const pressureEsInlineMeta = document.getElementById(\\\\\\\'pressureEsInlineMeta\\\\\\\');\\\\n        const pressureEsBox = document.getElementById(\\\\\\\'pressureEsBox\\\\\\\');\\\\n        const pressureSpxValue = document.getElementById(\\\\\\\'pressureSpxValue\\\\\\\');\\\\n        const pressureSpxMeta = document.getElementById(\\\\\\\'pressureSpxMeta\\\\\\\');\\\\n        const pressureSpxInlineMeta = document.getElementById(\\\\\\\'pressureSpxInlineMeta\\\\\\\');\\\\n        const pressureSpxBox = document.getElementById(\\\\\\\'pressureSpxBox\\\\\\\');\\\\n        const pressureSpyValue = document.getElementById(\\\\\\\'pressureSpyValue\\\\\\\');\\\\n        const pressureSpyMeta = document.getElementById(\\\\\\\'pressureSpyMeta\\\\\\\');\\\\n        const pressureSpyInlineMeta = document.getElementById(\\\\\\\'pressureSpyInlineMeta\\\\\\\');\\\\n        const pressureSpyBox = document.getElementById(\\\\\\\'pressureSpyBox\\\\\\\');\\\\n        const pressureXspValue = document.getElementById(\\\\\\\'pressureXspValue\\\\\\\');\\\\n        const pressureXspMeta = document.getElementById(\\\\\\\'pressureXspMeta\\\\\\\');\\\\n        const pressureXspInlineMeta = document.getElementById(\\\\\\\'pressureXspInlineMeta\\\\\\\');\\\\n        const pressureXspBox = document.getElementById(\\\\\\\'pressureXspBox\\\\\\\');\\\\n\\\\n        const pressureNvdaValue = document.getElementById(\\\\\\\'pressureNvdaValue\\\\\\\');\\\\n        const pressureNvdaMeta = document.getElementById(\\\\\\\'pressureNvdaMeta\\\\\\\');\\\\n        const pressureNvdaInlineMeta = document.getElementById(\\\\\\\'pressureNvdaInlineMeta\\\\\\\');\\\\n        const pressureNvdaBox = document.getElementById(\\\\\\\'pressureNvdaBox\\\\\\\');\\\\n        const pressureMsftValue = document.getElementById(\\\\\\\'pressureMsftValue\\\\\\\');\\\\n        const pressureMsftMeta = document.getElementById(\\\\\\\'pressureMsftMeta\\\\\\\');\\\\n        const pressureMsftInlineMeta = document.getElementById(\\\\\\\'pressureMsftInlineMeta\\\\\\\');\\\\n        const pressureMsftBox = document.getElementById(\\\\\\\'pressureMsftBox\\\\\\\');\\\\n        const pressureAaplValue = document.getElementById(\\\\\\\'pressureAaplValue\\\\\\\');\\\\n        const pressureAaplMeta = document.getElementById(\\\\\\\'pressureAaplMeta\\\\\\\');\\\\n        const pressureAaplInlineMeta = document.getElementById(\\\\\\\'pressureAaplInlineMeta\\\\\\\');\\\\n        const pressureAaplBox = document.getElementById(\\\\\\\'pressureAaplBox\\\\\\\');\\\\n        const pressureGoogValue = document.getElementById(\\\\\\\'pressureGoogValue\\\\\\\');\\\\n        const pressureGoogMeta = document.getElementById(\\\\\\\'pressureGoogMeta\\\\\\\');\\\\n        const pressureGoogInlineMeta = document.getElementById(\\\\\\\'pressureGoogInlineMeta\\\\\\\');\\\\n        const pressureGoogBox = document.getElementById(\\\\\\\'pressureGoogBox\\\\\\\');\\\\n        const pressureAmznValue = document.getElementById(\\\\\\\'pressureAmznValue\\\\\\\');\\\\n        const pressureAmznMeta = document.getElementById(\\\\\\\'pressureAmznMeta\\\\\\\');\\\\n        const pressureAmznInlineMeta = document.getElementById(\\\\\\\'pressureAmznInlineMeta\\\\\\\');\\\\n        const pressureAmznBox = document.getElementById(\\\\\\\'pressureAmznBox\\\\\\\');\\\\n        const overallPressureBox = document.getElementById(\\\\\\\'overallPressureBox\\\\\\\');\\\\n        const overallPressureValue = document.getElementById(\\\\\\\'overallPressureValue\\\\\\\');\\\\n        const overallPressureTime = document.getElementById(\\\\\\\'overallPressureTime\\\\\\\');\\\\n        const overallPressureInlineMeta = document.getElementById(\\\\\\\'overallPressureInlineMeta\\\\\\\');\\\\n\\\\n        const esPcrLabel = document.getElementById(\\\\\\\'esPcrLabel\\\\\\\');\\\\n        const spxPcrLabel = document.getElementById(\\\\\\\'spxPcrLabel\\\\\\\');\\\\n        const spyPcrLabel = document.getElementById(\\\\\\\'spyPcrLabel\\\\\\\');\\\\n        const xspPcrLabel = document.getElementById(\\\\\\\'xspPcrLabel\\\\\\\');\\\\n        const nvdaPcrLabel = document.getElementById(\\\\\\\'nvdaPcrLabel\\\\\\\');\\\\n        const msftPcrLabel = document.getElementById(\\\\\\\'msftPcrLabel\\\\\\\');\\\\n\\\\n        const msftLivePrice = document.getElementById(\\\\\\\'msftLivePrice\\\\\\\');\\\\n        const msftLiveTime = document.getElementById(\\\\\\\'msftLiveTime\\\\\\\');\\\\n        const msftGammaFlipTop = document.getElementById(\\\\\\\'msftGammaFlipTop\\\\\\\');\\\\n        const msftExpiryLabel = document.getElementById(\\\\\\\'msftExpiryLabel\\\\\\\');\\\\n        const msftLevelsModeSwitch = document.getElementById(\\\\\\\'msftLevelsModeSwitch\\\\\\\');\\\\n        const msftSupportsModeHint = document.getElementById(\\\\\\\'msftSupportsModeHint\\\\\\\');\\\\n        const msftResistancesModeHint = document.getElementById(\\\\\\\'msftResistancesModeHint\\\\\\\');\\\\n        const msftSupportsContainer = document.getElementById(\\\\\\\'msftSupportsContainer\\\\\\\');\\\\n        const msftSupportsNote = document.getElementById(\\\\\\\'msftSupportsNote\\\\\\\');\\\\n        const msftResistancesContainer = document.getElementById(\\\\\\\'msftResistancesContainer\\\\\\\');\\\\n        const msftResistancesNote = document.getElementById(\\\\\\\'msftResistancesNote\\\\\\\');\\\\n\\\\n        let pressureChart = null;\\\\n        let pressureSeries = null;\\\\n        const pressureData = [];\\\\n\\\\n        const PRESSURE_HISTORY_HOURS = 8;\\\\n        let _pressureHistoryLoaded = false;\\\\n        let _pressureLastSentTs = null;\\\\n        let _pressureLastSentScore = null;\\\\n\\\\n        const pressureChartResetBtn = document.getElementById(\\\\\\\'pressureChartResetBtn\\\\\\\');\\\\n\\\\n        function initTooltipsWithin(rootEl) {\\\\n            if (!rootEl || typeof bootstrap === \\\\\\\'undefined\\\\\\\' || !bootstrap.Tooltip) return;\\\\n            const els = rootEl.querySelectorAll(\\\\\\\'[data-bs-toggle="tooltip"]\\\\\\\');\\\\n            els.forEach((el) => {\\\\n                try {\\\\n                    bootstrap.Tooltip.getOrCreateInstance(el, { trigger: \\\\\\\'hover\\\\\\\', container: \\\\\\\'body\\\\\\\' });\\\\n                } catch (e) {\\\\n                    // no-op\\\\n                }\\\\n            });\\\\n        }\\\\n\\\\n        function setTooltip(el, text) {\\\\n            if (!el) return;\\\\n            const t = (text || \\\\\\\'\\\\\\\').toString();\\\\n            el.setAttribute(\\\\\\\'data-bs-title\\\\\\\', t);\\\\n            el.setAttribute(\\\\\\\'data-bs-toggle\\\\\\\', \\\\\\\'tooltip\\\\\\\');\\\\n\\\\n            if (typeof bootstrap === \\\\\\\'undefined\\\\\\\' || !bootstrap.Tooltip) return;\\\\n            try {\\\\n                const inst = bootstrap.Tooltip.getInstance(el);\\\\n                if (inst) {\\\\n                    try {\\\\n                        inst.setContent({ \\\\\\\'.tooltip-inner\\\\\\\': t });\\\\n                    } catch (e) {\\\\n                        try { inst.dispose(); } catch (e2) {}\\\\n                        bootstrap.Tooltip.getOrCreateInstance(el, { trigger: \\\\\\\'hover\\\\\\\', container: \\\\\\\'body\\\\\\\' });\\\\n                    }\\\\n                } else {\\\\n                    bootstrap.Tooltip.getOrCreateInstance(el, { trigger: \\\\\\\'hover\\\\\\\', container: \\\\\\\'body\\\\\\\' });\\\\n                }\\\\n            } catch (e) {\\\\n                // no-op\\\\n            }\\\\n        }\\\\n\\\\n        function clearTooltip(el) {\\\\n            if (!el) return;\\\\n            try {\\\\n                if (typeof bootstrap !== \\\\\\\'undefined\\\\\\\' && bootstrap.Tooltip) {\\\\n                    const inst = bootstrap.Tooltip.getInstance(el);\\\\n                    if (inst) inst.dispose();\\\\n                }\\\\n            } catch (e) {\\\\n                // no-op\\\\n            }\\\\n            try { el.removeAttribute(\\\\\\\'data-bs-title\\\\\\\'); } catch (e) {}\\\\n            try { el.removeAttribute(\\\\\\\'data-bs-toggle\\\\\\\'); } catch (e) {}\\\\n        }\\\\n\\\\n        function _levelsModeFromSwitch(sw) {\\\\n            return (sw && sw.checked) ? \\\\\\\'price\\\\\\\' : \\\\\\\'flip\\\\\\\';\\\\n        }\\\\n\\\\n        function _restoreLevelsModeSwitch(sw, storageKey) {\\\\n            if (!sw) return;\\\\n            try {\\\\n                const saved = (localStorage.getItem(storageKey) || \\\\\\\'price\\\\\\\').toLowerCase();\\\\n                sw.checked = saved === \\\\\\\'price\\\\\\\';\\\\n            } catch (e) {\\\\n                sw.checked = true;\\\\n            }\\\\n        }\\\\n\\\\n        function _persistLevelsModeSwitch(sw, storageKey) {\\\\n            if (!sw) return;\\\\n            try {\\\\n                localStorage.setItem(storageKey, _levelsModeFromSwitch(sw));\\\\n            } catch (e) {\\\\n                // ignore\\\\n            }\\\\n        }\\\\n\\\\n        function _formatLevelTooltip(callOi, putOi, gamma) {\\\\n            const callStr = Number(callOi || 0).toLocaleString();\\\\n            const putStr = Number(putOi || 0).toLocaleString();\\\\n            const k = Number.isFinite(Number(gamma)) ? (Number(gamma) / 1000) : 0;\\\\n            const kStr = `${k >= 0 ? \\\\\\\'+\\\\\\\' : \\\\\\\'\\\\\\\'}${k.toFixed(0)}K`;\\\\n            return `Call: ${callStr} | Put: ${putStr}\\\\\\\\n${kStr}`;\\\\n        }\\\\n\\\\n        function ensurePressureChart() {\\\\n            const el = document.getElementById(\\\\\\\'pressureChart\\\\\\\');\\\\n            if (!el || typeof LightweightCharts === \\\\\\\'undefined\\\\\\\') return;\\\\n            if (pressureChart && pressureSeries) return;\\\\n\\\\n            const width = Math.max(320, Math.floor((el.getBoundingClientRect && el.getBoundingClientRect().width) ? el.getBoundingClientRect().width : (el.clientWidth || 0)));\\\\n\\\\n            pressureChart = LightweightCharts.createChart(el, {\\\\n                width,\\\\n                height: 220,\\\\n                layout: {\\\\n                    background: { type: \\\\\\\'solid\\\\\\\', color: \\\\\\\'#0d1b2a\\\\\\\' },\\\\n                    textColor: \\\\\\\'#adb5bd\\\\\\\',\\\\n                },\\\\n                grid: {\\\\n                    vertLines: { color: \\\\\\\'rgba(119, 141, 169, 0.15)\\\\\\\' },\\\\n                    horzLines: { color: \\\\\\\'rgba(119, 141, 169, 0.15)\\\\\\\' },\\\\n                },\\\\n                rightPriceScale: {\\\\n                    borderColor: \\\\\\\'rgba(119, 141, 169, 0.25)\\\\\\\',\\\\n                },\\\\n                timeScale: {\\\\n                    borderColor: \\\\\\\'rgba(119, 141, 169, 0.25)\\\\\\\',\\\\n                    timeVisible: true,\\\\n                    secondsVisible: false,\\\\n                    rightOffset: 1,\\\\n                    barSpacing: 12,\\\\n                },\\\\n                crosshair: {\\\\n                    vertLine: { visible: false },\\\\n                    horzLine: { visible: false },\\\\n                },\\\\n                // Allow exploring history: drag to scroll, wheel to zoom X.\\\\n                // Keep vertical interactions off to avoid accidental Y scaling.\\\\n                handleScroll: {\\\\n                    pressedMouseMove: true,\\\\n                    mouseWheel: true,\\\\n                    horzTouchDrag: true,\\\\n                    vertTouchDrag: false,\\\\n                },\\\\n                handleScale: {\\\\n                    axisPressedMouseMove: false,\\\\n                    mouseWheel: true,\\\\n                    pinch: true,\\\\n                },\\\\n            });\\\\n\\\\n            pressureSeries = pressureChart.addHistogramSeries({\\\\n                base: 0,\\\\n                priceFormat: { type: \\\\\\\'price\\\\\\\', precision: 0, minMove: 1 },\\\\n                // Fallback color (individual bars override via data.color)\\\\n                color: \\\\\\\'rgba(45, 212, 191, 0.85)\\\\\\\',\\\\n                autoscaleInfoProvider: () => ({\\\\n                    priceRange: { minValue: -9, maxValue: 9 },\\\\n                }),\\\\n            });\\\\n\\\\n            // Make sure the +/- range is actually visible (not squashed).\\\\n            try {\\\\n                pressureChart.priceScale(\\\\\\\'right\\\\\\\').applyOptions({\\\\n                    scaleMargins: { top: 0.15, bottom: 0.15 },\\\\n                });\\\\n            } catch (e) {\\\\n                // no-op\\\\n            }\\\\n\\\\n            // Zero line reference.\\\\n            try {\\\\n                pressureSeries.createPriceLine({\\\\n                    price: 0,\\\\n                    color: \\\\\\\'rgba(224, 225, 221, 0.35)\\\\\\\',\\\\n                    lineWidth: 1,\\\\n                    lineStyle: 2,\\\\n                    axisLabelVisible: false,\\\\n                    title: \\\\\\\'\\\\\\\',\\\\n                });\\\\n            } catch (e) {\\\\n                // no-op\\\\n            }\\\\n\\\\n            const onResize = () => {\\\\n                if (!pressureChart || !el) return;\\\\n                const w = Math.max(320, Math.floor((el.getBoundingClientRect && el.getBoundingClientRect().width) ? el.getBoundingClientRect().width : (el.clientWidth || 0)));\\\\n                pressureChart.applyOptions({ width: w });\\\\n            };\\\\n            window.addEventListener(\\\\\\\'resize\\\\\\\', onResize);\\\\n\\\\n            // One more resize pass after layout settles.\\\\n            setTimeout(onResize, 0);\\\\n        }\\\\n\\\\n        function _pressureBarColor(score) {\\\\n            const v = Number(score);\\\\n            if (!Number.isFinite(v)) return \\\\\\\'rgba(119, 141, 169, 0.6)\\\\\\\';\\\\n            return v >= 0 ? \\\\\\\'rgba(45, 212, 191, 0.92)\\\\\\\' : \\\\\\\'rgba(251, 113, 133, 0.92)\\\\\\\';\\\\n        }\\\\n\\\\n        async function loadPressureHistory() {\\\\n            if (_pressureHistoryLoaded) return;\\\\n            ensurePressureChart();\\\\n            if (!pressureSeries) return;\\\\n\\\\n            try {\\\\n                const res = await fetch(`/api/pressure-history?hours=${encodeURIComponent(PRESSURE_HISTORY_HOURS)}`);\\\\n                const data = await res.json();\\\\n                if (!res.ok || data.error) throw new Error(data.error || \\\\\\\'history fetch failed\\\\\\\');\\\\n\\\\n                const points = Array.isArray(data.points) ? data.points : [];\\\\n                pressureData.length = 0;\\\\n                for (const p of points) {\\\\n                    const ts = Number(p.ts);\\\\n                    const score = Number(p.score);\\\\n                    if (!Number.isFinite(ts) || !Number.isFinite(score)) continue;\\\\n                    pressureData.push({ time: Math.floor(ts), value: score, color: _pressureBarColor(score) });\\\\n                }\\\\n\\\\n                // Ensure sorted and within last 8h window.\\\\n                pressureData.sort((a, b) => a.time - b.time);\\\\n                const nowTs = Math.floor(Date.now() / 1000);\\\\n                const cutoff = nowTs - PRESSURE_HISTORY_HOURS * 3600;\\\\n                while (pressureData.length && pressureData[0].time < cutoff) pressureData.shift();\\\\n\\\\n                pressureSeries.setData(pressureData);\\\\n                _pressureHistoryLoaded = true;\\\\n\\\\n                try {\\\\n                    if (pressureChart) pressureChart.timeScale().scrollToRealTime();\\\\n                } catch (e) {\\\\n                    // no-op\\\\n                }\\\\n            } catch (e) {\\\\n                // If Mongo isn\\\\\\\'t configured, the app should still work live.\\\\n                _pressureHistoryLoaded = true;\\\\n            }\\\\n        }\\\\n\\\\n        async function persistPressurePoint({ ts, score, breakdown }) {\\\\n            const t = Number(ts);\\\\n            const s = Number(score);\\\\n            if (!Number.isFinite(t) || !Number.isFinite(s)) return;\\\\n            if (_pressureLastSentTs === t && _pressureLastSentScore === s) return;\\\\n\\\\n            _pressureLastSentTs = t;\\\\n            _pressureLastSentScore = s;\\\\n\\\\n            try {\\\\n                await fetch(\\\\\\\'/api/pressure-point\\\\\\\', {\\\\n                    method: \\\\\\\'POST\\\\\\\',\\\\n                    headers: { \\\\\\\'Content-Type\\\\\\\': \\\\\\\'application/json\\\\\\\' },\\\\n                    body: JSON.stringify({ ts: Math.floor(t), score: s, breakdown: breakdown || null }),\\\\n                });\\\\n            } catch (e) {\\\\n                // ignore\\\\n            }\\\\n        }\\\\n\\\\n        function resetPressureChartView() {\\\\n            ensurePressureChart();\\\\n            if (!pressureChart) return;\\\\n            try {\\\\n                pressureChart.timeScale().applyOptions({ rightOffset: 1, barSpacing: 12 });\\\\n            } catch (e) {\\\\n                // no-op\\\\n            }\\\\n            try {\\\\n                pressureChart.timeScale().scrollToRealTime();\\\\n            } catch (e) {\\\\n                // no-op\\\\n            }\\\\n        }\\\\n\\\\n        if (pressureChartResetBtn) {\\\\n            pressureChartResetBtn.addEventListener(\\\\\\\'click\\\\\\\', resetPressureChartView);\\\\n        }\\\\n\\\\n        function _formatPressureMeta(price, gammaFlip) {\\\\n            const p = Number(price);\\\\n            const gf = Number(gammaFlip);\\\\n            const priceStr = Number.isFinite(p) ? p.toFixed(2) : \\\\\\\'--\\\\\\\';\\\\n            const gfStr = Number.isFinite(gf) ? gf.toFixed(2) : \\\\\\\'--\\\\\\\';\\\\n            return `px ${priceStr} | flip ${gfStr}`;\\\\n        }\\\\n\\\\n        function _inferSideFromDeltaAndGamma(delta, isPositiveGamma) {\\\\n            if (!Number.isFinite(delta) || delta === 0) return null;\\\\n            const dirUp = delta > 0;\\\\n            if (isPositiveGamma === true) {\\\\n                // Positive gamma: dealers hedge against the move (mean-reverting)\\\\n                return dirUp ? \\\\\\\'SELL\\\\\\\' : \\\\\\\'BUY\\\\\\\';\\\\n            }\\\\n            if (isPositiveGamma === false) {\\\\n                // Negative gamma: dealers hedge with the move (trend-reinforcing)\\\\n                return dirUp ? \\\\\\\'BUY\\\\\\\' : \\\\\\\'SELL\\\\\\\';\\\\n            }\\\\n            // If we can\\\\\\\'t determine gamma regime, fall back to pure momentum.\\\\n            return dirUp ? \\\\\\\'BUY\\\\\\\' : \\\\\\\'SELL\\\\\\\';\\\\n        }\\\\n\\\\n        function _setPressureText(el, side) {\\\\n            if (!el) return;\\\\n            el.classList.remove(\\\\\\\'text-support\\\\\\\', \\\\\\\'text-resistance\\\\\\\');\\\\n            if (side === \\\\\\\'BUY\\\\\\\') {\\\\n                el.classList.add(\\\\\\\'text-support\\\\\\\');\\\\n                el.textContent = \\\\\\\'BUY\\\\\\\';\\\\n            } else if (side === \\\\\\\'SELL\\\\\\\') {\\\\n                el.classList.add(\\\\\\\'text-resistance\\\\\\\');\\\\n                el.textContent = \\\\\\\'SELL\\\\\\\';\\\\n            } else {\\\\n                el.textContent = \\\\\\\'--\\\\\\\';\\\\n            }\\\\n        }\\\\n\\\\n        function _setPressureBorder(boxEl, side) {\\\\n            if (!boxEl) return;\\\\n            boxEl.classList.remove(\\\\\\\'pressure-buy\\\\\\\', \\\\\\\'pressure-sell\\\\\\\');\\\\n            if (side === \\\\\\\'BUY\\\\\\\') boxEl.classList.add(\\\\\\\'pressure-buy\\\\\\\');\\\\n            if (side === \\\\\\\'SELL\\\\\\\') boxEl.classList.add(\\\\\\\'pressure-sell\\\\\\\');\\\\n        }\\\\n\\\\n        function _computeInstrumentPressure({ price, gammaFlip, prevPrice }) {\\\\n            const p = Number(price);\\\\n            const prev = Number(prevPrice);\\\\n            if (!Number.isFinite(p) || !Number.isFinite(prev)) {\\\\n                return { side: null, delta: null, isPositiveGamma: null };\\\\n            }\\\\n            const delta = p - prev;\\\\n\\\\n            const gf = Number(gammaFlip);\\\\n            const isPositiveGamma = Number.isFinite(gf) ? (p >= gf) : null;\\\\n            const side = _inferSideFromDeltaAndGamma(delta, isPositiveGamma);\\\\n            return { side, delta, isPositiveGamma };\\\\n        }\\\\n\\\\n        function updatePressureUI() {\\\\n            ensurePressureChart();\\\\n            loadPressureHistory();\\\\n            const es = _computeInstrumentPressure({ price: latestEsPrice, gammaFlip: latestEsGammaFlip, prevPrice: prevEsPrice });\\\\n            const spx = _computeInstrumentPressure({ price: latestSpxPrice, gammaFlip: latestSpxGammaFlip, prevPrice: prevSpxPrice });\\\\n            const spy = _computeInstrumentPressure({ price: latestSpyPrice, gammaFlip: latestSpyGammaFlip, prevPrice: prevSpyPrice });\\\\n            const xsp = _computeInstrumentPressure({ price: latestXspPrice, gammaFlip: latestXspGammaFlip, prevPrice: prevXspPrice });\\\\n            const nvda = _computeInstrumentPressure({ price: latestNvdaPrice, gammaFlip: latestNvdaGammaFlip, prevPrice: prevNvdaPrice });\\\\n            const msft = _computeInstrumentPressure({ price: latestMsftPrice, gammaFlip: latestMsftGammaFlip, prevPrice: prevMsftPrice });\\\\n            const aapl = _computeInstrumentPressure({ price: latestAaplPrice, gammaFlip: latestAaplGammaFlip, prevPrice: prevAaplPrice });\\\\n            const goog = _computeInstrumentPressure({ price: latestGoogPrice, gammaFlip: latestGoogGammaFlip, prevPrice: prevGoogPrice });\\\\n            const amzn = _computeInstrumentPressure({ price: latestAmznPrice, gammaFlip: latestAmznGammaFlip, prevPrice: prevAmznPrice });\\\\n\\\\n            _setPressureText(pressureEsValue, es.side);\\\\n            if (pressureEsInlineMeta) pressureEsInlineMeta.textContent = `(${_formatPressureMeta(latestEsPrice, latestEsGammaFlip)})`;\\\\n            _setPressureBorder(pressureEsBox, es.side);\\\\n\\\\n            _setPressureText(pressureSpxValue, spx.side);\\\\n            if (pressureSpxInlineMeta) pressureSpxInlineMeta.textContent = `(${_formatPressureMeta(latestSpxPrice, latestSpxGammaFlip)})`;\\\\n            _setPressureBorder(pressureSpxBox, spx.side);\\\\n\\\\n            _setPressureText(pressureSpyValue, spy.side);\\\\n            if (pressureSpyInlineMeta) pressureSpyInlineMeta.textContent = `(${_formatPressureMeta(latestSpyPrice, latestSpyGammaFlip)})`;\\\\n            _setPressureBorder(pressureSpyBox, spy.side);\\\\n\\\\n            _setPressureText(pressureXspValue, xsp.side);\\\\n            if (pressureXspInlineMeta) pressureXspInlineMeta.textContent = `(${_formatPressureMeta(latestXspPrice, latestXspGammaFlip)})`;\\\\n            _setPressureBorder(pressureXspBox, xsp.side);\\\\n\\\\n            _setPressureText(pressureNvdaValue, nvda.side);\\\\n            if (pressureNvdaInlineMeta) pressureNvdaInlineMeta.textContent = `(${_formatPressureMeta(latestNvdaPrice, latestNvdaGammaFlip)})`;\\\\n            _setPressureBorder(pressureNvdaBox, nvda.side);\\\\n\\\\n            _setPressureText(pressureMsftValue, msft.side);\\\\n            if (pressureMsftInlineMeta) pressureMsftInlineMeta.textContent = `(${_formatPressureMeta(latestMsftPrice, latestMsftGammaFlip)})`;\\\\n            _setPressureBorder(pressureMsftBox, msft.side);\\\\n\\\\n            _setPressureText(pressureAaplValue, aapl.side);\\\\n            if (pressureAaplInlineMeta) pressureAaplInlineMeta.textContent = `(${_formatPressureMeta(latestAaplPrice, latestAaplGammaFlip)})`;\\\\n            _setPressureBorder(pressureAaplBox, aapl.side);\\\\n\\\\n            _setPressureText(pressureGoogValue, goog.side);\\\\n            if (pressureGoogInlineMeta) pressureGoogInlineMeta.textContent = `(${_formatPressureMeta(latestGoogPrice, latestGoogGammaFlip)})`;\\\\n            _setPressureBorder(pressureGoogBox, goog.side);\\\\n\\\\n            _setPressureText(pressureAmznValue, amzn.side);\\\\n            if (pressureAmznInlineMeta) pressureAmznInlineMeta.textContent = `(${_formatPressureMeta(latestAmznPrice, latestAmznGammaFlip)})`;\\\\n            _setPressureBorder(pressureAmznBox, amzn.side);\\\\n\\\\n            const sides = [es.side, spx.side, spy.side, xsp.side, nvda.side, msft.side, aapl.side, goog.side, amzn.side].filter(Boolean);\\\\n            let buyCount = 0;\\\\n            let sellCount = 0;\\\\n            sides.forEach(s => {\\\\n                if (s === \\\\\\\'BUY\\\\\\\') buyCount += 1;\\\\n                if (s === \\\\\\\'SELL\\\\\\\') sellCount += 1;\\\\n            });\\\\n\\\\n            const overallSide = sides.length === 0 ? null : (buyCount >= sellCount ? \\\\\\\'BUY\\\\\\\' : \\\\\\\'SELL\\\\\\\');\\\\n            _setPressureText(overallPressureValue, overallSide);\\\\n            _setPressureBorder(overallPressureBox, overallSide);\\\\n            if (overallPressureTime) {\\\\n                const now = new Date();\\\\n                const t = `Updated ${now.toLocaleTimeString()}`;\\\\n                overallPressureTime.textContent = \\\\\\\'\\\\\\\';\\\\n                if (overallPressureInlineMeta) overallPressureInlineMeta.textContent = `(${t})`;\\\\n                clearTooltip(overallPressureBox);\\\\n            }\\\\n\\\\n            // Chart: combined score across instruments (-4..+4)\\\\n            if (pressureSeries) {\\\\n                const scoreFor = (side) => (side === \\\\\\\'BUY\\\\\\\' ? 1 : (side === \\\\\\\'SELL\\\\\\\' ? -1 : 0));\\\\n                const score = scoreFor(es.side) + scoreFor(spx.side) + scoreFor(spy.side) + scoreFor(xsp.side) + scoreFor(nvda.side) + scoreFor(msft.side) + scoreFor(aapl.side) + scoreFor(goog.side) + scoreFor(amzn.side);\\\\n                const ts = Math.floor(Date.now() / 1000);\\\\n\\\\n                // IMPORTANT: LightweightCharts expects strictly increasing times.\\\\n                // If we get multiple updates within the same second, update the last bar instead of pushing.\\\\n                const color = _pressureBarColor(score);\\\\n                const last = pressureData.length ? pressureData[pressureData.length - 1] : null;\\\\n\\\\n                if (!last) {\\\\n                    pressureData.push({ time: ts, value: score, color });\\\\n                    pressureSeries.setData(pressureData);\\\\n                } else if (ts === last.time) {\\\\n                    last.value = score;\\\\n                    last.color = color;\\\\n                    pressureSeries.setData(pressureData);\\\\n                } else if (ts > last.time) {\\\\n                    pressureData.push({ time: ts, value: score, color });\\\\n                    // Keep at least the last 8 hours of points.\\\\n                    const cutoff = ts - PRESSURE_HISTORY_HOURS * 3600;\\\\n                    while (pressureData.length && pressureData[0].time < cutoff) pressureData.shift();\\\\n                    pressureSeries.setData(pressureData);\\\\n                } else {\\\\n                    // Clock skew / time went backwards; ignore this tick.\\\\n                }\\\\n\\\\n                // Persist the point (async, best-effort).\\\\n                persistPressurePoint({\\\\n                    ts,\\\\n                    score,\\\\n                    breakdown: {\\\\n                        overall: overallSide,\\\\n                        instruments: {\\\\n                            ES: es.side,\\\\n                            SPX: spx.side,\\\\n                            SPY: spy.side,\\\\n                            XSP: xsp.side,\\\\n                            NVDA: nvda.side,\\\\n                            MSFT: msft.side,\\\\n                            AAPL: aapl.side,\\\\n                            GOOG: goog.side,\\\\n                            AMZN: amzn.side,\\\\n                        },\\\\n                    },\\\\n                });\\\\n            }\\\\n        }\\\\n\\\\n        function heatClassForIndex(i) {\\\\n            if (i <= 0) return \\\\\\\'heat-1\\\\\\\';\\\\n            if (i === 1) return \\\\\\\'heat-2\\\\\\\';\\\\n            if (i === 2) return \\\\\\\'heat-3\\\\\\\';\\\\n            return \\\\\\\'heat-4\\\\\\\';\\\\n        }\\\\n\\\\n        function setPutCallRatio(labelEl, stats) {\\\\n            if (!labelEl) return;\\\\n            const r = Number(stats && stats.put_call_ratio);\\\\n            labelEl.textContent = Number.isFinite(r) ? `PCR ${r.toFixed(2)}` : \\\\\\\'\\\\\\\';\\\\n        }\\\\n\\\\n        function getNearThreshold(price, { rel = 0.00075, minAbs = 0.5 } = {}) {\\\\n            const p = Number(price);\\\\n            if (!Number.isFinite(p) || p <= 0) return null;\\\\n            return Math.max(minAbs, p * rel);\\\\n        }\\\\n\\\\n        function applyNearSignals(containerEl, currentPrice, opts) {\\\\n            if (!containerEl) return;\\\\n            const threshold = getNearThreshold(currentPrice, opts);\\\\n            const items = containerEl.querySelectorAll(\\\\\\\'.level-item[data-strike]\\\\\\\');\\\\n            if (!Number.isFinite(Number(currentPrice)) || threshold == null) {\\\\n                items.forEach(el => el.classList.remove(\\\\\\\'near-level\\\\\\\'));\\\\n                return;\\\\n            }\\\\n\\\\n            const cp = Number(currentPrice);\\\\n            items.forEach(el => {\\\\n                const strike = Number(el.getAttribute(\\\\\\\'data-strike\\\\\\\'));\\\\n                if (!Number.isFinite(strike)) {\\\\n                    el.classList.remove(\\\\\\\'near-level\\\\\\\');\\\\n                    return;\\\\n                }\\\\n                const near = Math.abs(strike - cp) <= threshold;\\\\n                el.classList.toggle(\\\\\\\'near-level\\\\\\\', near);\\\\n            });\\\\n        }\\\\n\\\\n        function updateEsNearSignals() {\\\\n            const supportsContainer = document.getElementById(\\\\\\\'supportsContainer\\\\\\\');\\\\n            const resistancesContainer = document.getElementById(\\\\\\\'resistancesContainer\\\\\\\');\\\\n            applyNearSignals(supportsContainer, latestEsPrice, { minAbs: 5, rel: 0.00075 });\\\\n            applyNearSignals(resistancesContainer, latestEsPrice, { minAbs: 5, rel: 0.00075 });\\\\n        }\\\\n\\\\n        function updateNvdaNearSignals() {\\\\n            applyNearSignals(nvdaSupportsContainer, latestNvdaPrice, { minAbs: 0.5, rel: 0.00075 });\\\\n            applyNearSignals(nvdaResistancesContainer, latestNvdaPrice, { minAbs: 0.5, rel: 0.00075 });\\\\n        }\\\\n\\\\n        function updateSpyNearSignals() {\\\\n            // SPY key levels removed from UI; kept for backward compatibility.\\\\n        }\\\\n\\\\n        function updateMsftNearSignals() {\\\\n            applyNearSignals(msftSupportsContainer, latestMsftPrice, { minAbs: 0.25, rel: 0.00075 });\\\\n            applyNearSignals(msftResistancesContainer, latestMsftPrice, { minAbs: 0.25, rel: 0.00075 });\\\\n        }\\\\n\\\\n        function updateSpxNearSignals() {\\\\n            // SPX key levels removed from UI; kept for backward compatibility.\\\\n        }\\\\n\\\\n        function updateXspNearSignals() {\\\\n            // XSP key levels removed from UI; kept for backward compatibility.\\\\n        }\\\\n\\\\n        function displaySpxKeyLevels(data) {\\\\n            if (spxExpiryLabel) {\\\\n                if (data && data.expiration) {\\\\n                    spxExpiryLabel.textContent = `(nearest expiry: ${data.expiration})`;\\\\n                } else {\\\\n                    spxExpiryLabel.textContent = \\\\\\\'\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (!data || data.error) {\\\\n                setPutCallRatio(spxPcrLabel, null);\\\\n                if (spxSupportsContainer) spxSupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (spxResistancesContainer) spxResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (spxSupportsNote) spxSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                if (spxResistancesNote) spxResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                return;\\\\n            }\\\\n\\\\n            setPutCallRatio(spxPcrLabel, data.stats);\\\\n\\\\n            const supports = Array.isArray(data.supports) ? data.supports : [];\\\\n            const resistances = Array.isArray(data.resistances) ? data.resistances : [];\\\\n\\\\n            if (spxSupportsContainer) {\\\\n                if (supports.length > 0) {\\\\n                    spxSupportsContainer.innerHTML = supports.map((s, i) => `\\\\n                        <div class="level-item support-item ${heatClassForIndex(i)}" data-strike="${Number(s.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div>\\\\n                                    <div class="fw-bold text-support fs-5">S${i + 1}  ${Number(s.strike).toFixed(2)}</div>\\\\n                                    <div class="text-muted small">Call: ${Number(s.call_oi).toLocaleString()} | Put: ${Number(s.put_oi).toLocaleString()}</div>\\\\n                                </div>\\\\n                                <div class="fw-bold text-support fs-5 level-metric">+${(Number(s.gamma) / 1000).toFixed(0)}K</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n                } else {\\\\n                    spxSupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No support below price</p>\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (spxSupportsNote) {\\\\n                if (data.supports_note) {\\\\n                    spxSupportsNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.supports_note;\\\\n                    spxSupportsNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    spxSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (spxResistancesContainer) {\\\\n                if (resistances.length > 0) {\\\\n                    spxResistancesContainer.innerHTML = resistances.map((r, i) => `\\\\n                        <div class="level-item resistance-item ${heatClassForIndex(i)}" data-strike="${Number(r.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div>\\\\n                                    <div class="fw-bold text-resistance fs-5">R${i + 1}  ${Number(r.strike).toFixed(2)}</div>\\\\n                                    <div class="text-muted small">Call: ${Number(r.call_oi).toLocaleString()} | Put: ${Number(r.put_oi).toLocaleString()}</div>\\\\n                                </div>\\\\n                                <div class="fw-bold text-resistance fs-5 level-metric">${(Number(r.gamma) / 1000).toFixed(0)}K</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n                } else {\\\\n                    spxResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No resistance above price</p>\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (spxResistancesNote) {\\\\n                if (data.resistances_note) {\\\\n                    spxResistancesNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.resistances_note;\\\\n                    spxResistancesNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    spxResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            updateSpxNearSignals();\\\\n        }\\\\n\\\\n        function displayXspKeyLevels(data) {\\\\n            if (xspExpiryLabel) {\\\\n                if (data && data.expiration) {\\\\n                    xspExpiryLabel.textContent = `(nearest expiry: ${data.expiration})`;\\\\n                } else {\\\\n                    xspExpiryLabel.textContent = \\\\\\\'\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (!data || data.error) {\\\\n                setPutCallRatio(xspPcrLabel, null);\\\\n                if (xspSupportsContainer) xspSupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (xspResistancesContainer) xspResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (xspSupportsNote) xspSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                if (xspResistancesNote) xspResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                return;\\\\n            }\\\\n\\\\n            setPutCallRatio(xspPcrLabel, data.stats);\\\\n\\\\n            const supports = Array.isArray(data.supports) ? data.supports : [];\\\\n            const resistances = Array.isArray(data.resistances) ? data.resistances : [];\\\\n\\\\n            if (xspSupportsContainer) {\\\\n                if (supports.length > 0) {\\\\n                    xspSupportsContainer.innerHTML = supports.map((s, i) => `\\\\n                        <div class="level-item support-item ${heatClassForIndex(i)}" data-strike="${Number(s.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div>\\\\n                                    <div class="fw-bold text-support fs-5">S${i + 1}  ${Number(s.strike).toFixed(2)}</div>\\\\n                                    <div class="text-muted small">Call: ${Number(s.call_oi).toLocaleString()} | Put: ${Number(s.put_oi).toLocaleString()}</div>\\\\n                                </div>\\\\n                                <div class="fw-bold text-support fs-5 level-metric">+${(Number(s.gamma) / 1000).toFixed(0)}K</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n                } else {\\\\n                    xspSupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No support below price</p>\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (xspSupportsNote) {\\\\n                if (data.supports_note) {\\\\n                    xspSupportsNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.supports_note;\\\\n                    xspSupportsNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    xspSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (xspResistancesContainer) {\\\\n                if (resistances.length > 0) {\\\\n                    xspResistancesContainer.innerHTML = resistances.map((r, i) => `\\\\n                        <div class="level-item resistance-item ${heatClassForIndex(i)}" data-strike="${Number(r.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div>\\\\n                                    <div class="fw-bold text-resistance fs-5">R${i + 1}  ${Number(r.strike).toFixed(2)}</div>\\\\n                                    <div class="text-muted small">Call: ${Number(r.call_oi).toLocaleString()} | Put: ${Number(r.put_oi).toLocaleString()}</div>\\\\n                                </div>\\\\n                                <div class="fw-bold text-resistance fs-5 level-metric">${(Number(r.gamma) / 1000).toFixed(0)}K</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n                } else {\\\\n                    xspResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No resistance above price</p>\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (xspResistancesNote) {\\\\n                if (data.resistances_note) {\\\\n                    xspResistancesNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.resistances_note;\\\\n                    xspResistancesNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    xspResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            updateXspNearSignals();\\\\n        }\\\\n\\\\n        async function loadEsPrice() {\\\\n            if (esLoadPromise) return esLoadPromise;\\\\n\\\\n            esLoadPromise = (async () => {\\\\n                try {\\\\n                    const response = await fetch(\\\\\\\'/api/es-price\\\\\\\');\\\\n                    const data = await response.json();\\\\n\\\\n                    if (!response.ok || data.error) {\\\\n                        throw new Error(data.error || \\\\\\\'Price fetch failed\\\\\\\');\\\\n                    }\\\\n\\\\n                    const price = Number(data.price);\\\\n                    if (!Number.isFinite(price)) {\\\\n                        throw new Error(\\\\\\\'Invalid price\\\\\\\');\\\\n                    }\\\\n\\\\n                    const symbol = (data.symbol || \\\\\\\'S&P 500\\\\\\\').toString().toUpperCase();\\\\n                    const when = [data.date, data.time].filter(Boolean).join(\\\\\\\' \\\\\\\');\\\\n                    const note = data.note ? ` - ${data.note}` : \\\\\\\'\\\\\\\';\\\\n\\\\n                    if (latestEsPrice != null) prevEsPrice = latestEsPrice;\\\\n                    latestEsPrice = price;\\\\n                    if (prevEsPrice == null) prevEsPrice = latestEsPrice;\\\\n                    if (esLivePrice) {\\\\n                        esLivePrice.textContent = `${price.toFixed(2)}`;\\\\n                    }\\\\n                    if (esLiveTime) {\\\\n                        esLiveTime.textContent = (when || \\\\\\\'--\\\\\\\') + note;\\\\n                    }\\\\n\\\\n                    setTooltip(esLiveBox, `Updated: ${(when || \\\\\\\'--\\\\\\\')}${note}`);\\\\n\\\\n                    updateEsNearSignals();\\\\n                    updatePressureUI();\\\\n\\\\n                    return price;\\\\n                } catch (e) {\\\\n                    if (esLivePrice) esLivePrice.textContent = \\\\\\\'--\\\\\\\';\\\\n                    if (esLiveTime) esLiveTime.textContent = \\\\\\\'--\\\\\\\';\\\\n                    latestEsPrice = null;\\\\n                    setTooltip(esLiveBox, \\\\\\\'--\\\\\\\');\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return esLoadPromise;\\\\n        }\\\\n\\\\n        async function refreshEsPrice() {\\\\n            // Force a fresh fetch cycle even if a previous one is cached in-flight.\\\\n            esLoadPromise = null;\\\\n            return loadEsPrice();\\\\n        }\\\\n\\\\n        function startEsPricePolling() {\\\\n            if (esPollIntervalId) return;\\\\n            refreshEsPrice();\\\\n            esPollIntervalId = setInterval(refreshEsPrice, 5000);\\\\n        }\\\\n\\\\n        function stopEsPricePolling() {\\\\n            if (!esPollIntervalId) return;\\\\n            clearInterval(esPollIntervalId);\\\\n            esPollIntervalId = null;\\\\n        }\\\\n\\\\n        async function loadNvdaSnapshot() {\\\\n            if (nvdaLoadPromise) return nvdaLoadPromise;\\\\n\\\\n            nvdaLoadPromise = (async () => {\\\\n                try {\\\\n                    const mode = _levelsModeFromSwitch(nvdaLevelsModeSwitch);\\\\n                    const response = await fetch(`/api/nvda-snapshot?levels_mode=${encodeURIComponent(mode)}`);\\\\n                    const data = await response.json();\\\\n\\\\n                    if (!response.ok || data.error) {\\\\n                        throw new Error(data.error || \\\\\\\'NVDA fetch failed\\\\\\\');\\\\n                    }\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n                    const when = (data.time || \\\\\\\'\\\\\\\').toString();\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestNvdaPrice != null) prevNvdaPrice = latestNvdaPrice;\\\\n                        latestNvdaPrice = price;\\\\n                    } else {\\\\n                        latestNvdaPrice = null;\\\\n                    }\\\\n                    latestNvdaGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    if (nvdaLivePrice) {\\\\n                        nvdaLivePrice.textContent = Number.isFinite(price) ? `${price.toFixed(2)}` : \\\\\\\'--\\\\\\\';\\\\n                    }\\\\n                    if (nvdaLiveTime) {\\\\n                        nvdaLiveTime.textContent = when || (data.expiration ? `Exp ${data.expiration}` : \\\\\\\'--\\\\\\\');\\\\n                    }\\\\n                    if (nvdaGammaFlipTop) {\\\\n                        nvdaGammaFlipTop.textContent = Number.isFinite(gammaFlip) ? `${gammaFlip.toFixed(2)}` : \\\\\\\'--\\\\\\\';\\\\n                    }\\\\n\\\\n                    displayNvdaKeyLevels(data);\\\\n                    updateNvdaNearSignals();\\\\n                    updatePressureUI();\\\\n\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    if (nvdaLivePrice) nvdaLivePrice.textContent = \\\\\\\'--\\\\\\\';\\\\n                    if (nvdaLiveTime) nvdaLiveTime.textContent = \\\\\\\'--\\\\\\\';\\\\n                    if (nvdaGammaFlipTop) nvdaGammaFlipTop.textContent = \\\\\\\'--\\\\\\\';\\\\n                    latestNvdaPrice = null;\\\\n                    latestNvdaGammaFlip = null;\\\\n                    displayNvdaKeyLevels(null);\\\\n                    updateNvdaNearSignals();\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return nvdaLoadPromise;\\\\n        }\\\\n\\\\n        async function loadSpySnapshot() {\\\\n            if (spyLoadPromise) return spyLoadPromise;\\\\n\\\\n            spyLoadPromise = (async () => {\\\\n                try {\\\\n                    const response = await fetch(\\\\\\\'/api/spy-snapshot\\\\\\\');\\\\n                    const data = await response.json();\\\\n\\\\n                    if (!response.ok || data.error) {\\\\n                        throw new Error(data.error || \\\\\\\'SPY fetch failed\\\\\\\');\\\\n                    }\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n                    const when = (data.time || \\\\\\\'\\\\\\\').toString();\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestSpyPrice != null) prevSpyPrice = latestSpyPrice;\\\\n                        latestSpyPrice = price;\\\\n                    } else {\\\\n                        latestSpyPrice = null;\\\\n                    }\\\\n                    latestSpyGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    updatePressureUI();\\\\n\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    latestSpyPrice = null;\\\\n                    latestSpyGammaFlip = null;\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return spyLoadPromise;\\\\n        }\\\\n\\\\n        async function loadMsftSnapshot() {\\\\n            if (msftLoadPromise) return msftLoadPromise;\\\\n\\\\n            msftLoadPromise = (async () => {\\\\n                try {\\\\n                    const mode = _levelsModeFromSwitch(msftLevelsModeSwitch);\\\\n                    const response = await fetch(`/api/msft-snapshot?levels_mode=${encodeURIComponent(mode)}`);\\\\n                    const data = await response.json();\\\\n\\\\n                    if (!response.ok || data.error) {\\\\n                        throw new Error(data.error || \\\\\\\'MSFT fetch failed\\\\\\\');\\\\n                    }\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n                    const when = (data.time || \\\\\\\'\\\\\\\').toString();\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestMsftPrice != null) prevMsftPrice = latestMsftPrice;\\\\n                        latestMsftPrice = price;\\\\n                    } else {\\\\n                        latestMsftPrice = null;\\\\n                    }\\\\n                    latestMsftGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    if (msftLivePrice) {\\\\n                        msftLivePrice.textContent = Number.isFinite(price) ? `${price.toFixed(2)}` : \\\\\\\'--\\\\\\\';\\\\n                    }\\\\n                    if (msftLiveTime) {\\\\n                        msftLiveTime.textContent = when || (data.expiration ? `Exp ${data.expiration}` : \\\\\\\'--\\\\\\\');\\\\n                    }\\\\n                    if (msftGammaFlipTop) {\\\\n                        msftGammaFlipTop.textContent = Number.isFinite(gammaFlip) ? `${gammaFlip.toFixed(2)}` : \\\\\\\'--\\\\\\\';\\\\n                    }\\\\n\\\\n                    displayMsftKeyLevels(data);\\\\n                    updateMsftNearSignals();\\\\n                    updatePressureUI();\\\\n\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    if (msftLivePrice) msftLivePrice.textContent = \\\\\\\'--\\\\\\\';\\\\n                    if (msftLiveTime) msftLiveTime.textContent = \\\\\\\'--\\\\\\\';\\\\n                    if (msftGammaFlipTop) msftGammaFlipTop.textContent = \\\\\\\'--\\\\\\\';\\\\n                    latestMsftPrice = null;\\\\n                    latestMsftGammaFlip = null;\\\\n                    displayMsftKeyLevels(null);\\\\n                    updateMsftNearSignals();\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return msftLoadPromise;\\\\n        }\\\\n\\\\n        async function loadSpxSnapshot() {\\\\n            if (spxLoadPromise) return spxLoadPromise;\\\\n\\\\n            spxLoadPromise = (async () => {\\\\n                try {\\\\n                    const response = await fetch(\\\\\\\'/api/spx-snapshot\\\\\\\');\\\\n                    const data = await response.json();\\\\n\\\\n                    if (!response.ok || data.error) {\\\\n                        throw new Error(data.error || \\\\\\\'SPX fetch failed\\\\\\\');\\\\n                    }\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n                    const when = (data.time || \\\\\\\'\\\\\\\').toString();\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestSpxPrice != null) prevSpxPrice = latestSpxPrice;\\\\n                        latestSpxPrice = price;\\\\n                    } else {\\\\n                        latestSpxPrice = null;\\\\n                    }\\\\n                    latestSpxGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    updatePressureUI();\\\\n\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    latestSpxPrice = null;\\\\n                    latestSpxGammaFlip = null;\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return spxLoadPromise;\\\\n        }\\\\n\\\\n        async function refreshSpxSnapshot() {\\\\n            spxLoadPromise = null;\\\\n            return loadSpxSnapshot();\\\\n        }\\\\n\\\\n        function startSpxPolling() {\\\\n            if (spxPollIntervalId) return;\\\\n            refreshSpxSnapshot();\\\\n            spxPollIntervalId = setInterval(refreshSpxSnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopSpxPolling() {\\\\n            if (!spxPollIntervalId) return;\\\\n            clearInterval(spxPollIntervalId);\\\\n            spxPollIntervalId = null;\\\\n        }\\\\n\\\\n        async function loadXspSnapshot() {\\\\n            if (xspLoadPromise) return xspLoadPromise;\\\\n\\\\n            xspLoadPromise = (async () => {\\\\n                try {\\\\n                    const response = await fetch(\\\\\\\'/api/xsp-snapshot\\\\\\\');\\\\n                    const data = await response.json();\\\\n\\\\n                    if (!response.ok || data.error) {\\\\n                        throw new Error(data.error || \\\\\\\'XSP fetch failed\\\\\\\');\\\\n                    }\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n                    const when = (data.time || \\\\\\\'\\\\\\\').toString();\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestXspPrice != null) prevXspPrice = latestXspPrice;\\\\n                        latestXspPrice = price;\\\\n                    } else {\\\\n                        latestXspPrice = null;\\\\n                    }\\\\n                    latestXspGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    updatePressureUI();\\\\n\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    latestXspPrice = null;\\\\n                    latestXspGammaFlip = null;\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return xspLoadPromise;\\\\n        }\\\\n\\\\n        async function refreshXspSnapshot() {\\\\n            xspLoadPromise = null;\\\\n            return loadXspSnapshot();\\\\n        }\\\\n\\\\n        function startXspPolling() {\\\\n            if (xspPollIntervalId) return;\\\\n            refreshXspSnapshot();\\\\n            xspPollIntervalId = setInterval(refreshXspSnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopXspPolling() {\\\\n            if (!xspPollIntervalId) return;\\\\n            clearInterval(xspPollIntervalId);\\\\n            xspPollIntervalId = null;\\\\n        }\\\\n\\\\n        async function refreshMsftSnapshot() {\\\\n            msftLoadPromise = null;\\\\n            return loadMsftSnapshot();\\\\n        }\\\\n\\\\n        function startMsftPolling() {\\\\n            if (msftPollIntervalId) return;\\\\n            refreshMsftSnapshot();\\\\n            msftPollIntervalId = setInterval(refreshMsftSnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopMsftPolling() {\\\\n            if (!msftPollIntervalId) return;\\\\n            clearInterval(msftPollIntervalId);\\\\n            msftPollIntervalId = null;\\\\n        }\\\\n\\\\n        async function refreshSpySnapshot() {\\\\n            spyLoadPromise = null;\\\\n            return loadSpySnapshot();\\\\n        }\\\\n\\\\n        function startSpyPolling() {\\\\n            if (spyPollIntervalId) return;\\\\n            refreshSpySnapshot();\\\\n            spyPollIntervalId = setInterval(refreshSpySnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopSpyPolling() {\\\\n            if (!spyPollIntervalId) return;\\\\n            clearInterval(spyPollIntervalId);\\\\n            spyPollIntervalId = null;\\\\n        }\\\\n\\\\n        async function refreshNvdaSnapshot() {\\\\n            nvdaLoadPromise = null;\\\\n            return loadNvdaSnapshot();\\\\n        }\\\\n\\\\n        function startNvdaPolling() {\\\\n            if (nvdaPollIntervalId) return;\\\\n            refreshNvdaSnapshot();\\\\n            nvdaPollIntervalId = setInterval(refreshNvdaSnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopNvdaPolling() {\\\\n            if (!nvdaPollIntervalId) return;\\\\n            clearInterval(nvdaPollIntervalId);\\\\n            nvdaPollIntervalId = null;\\\\n        }\\\\n\\\\n        function displayNvdaKeyLevels(data) {\\\\n            if (nvdaExpiryLabel) {\\\\n                if (data && data.expiration) {\\\\n                    nvdaExpiryLabel.textContent = `(nearest expiry: ${data.expiration})`;\\\\n                } else {\\\\n                    nvdaExpiryLabel.textContent = \\\\\\\'\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (!data || data.error) {\\\\n                setPutCallRatio(nvdaPcrLabel, null);\\\\n                if (nvdaSupportsContainer) nvdaSupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (nvdaResistancesContainer) nvdaResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (nvdaSupportsNote) nvdaSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                if (nvdaResistancesNote) nvdaResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                return;\\\\n            }\\\\n\\\\n            setPutCallRatio(nvdaPcrLabel, data.stats);\\\\n\\\\n            const mode = (data && data.levels_mode ? String(data.levels_mode) : _levelsModeFromSwitch(nvdaLevelsModeSwitch)).toLowerCase();\\\\n            if (nvdaSupportsModeHint) {\\\\n                nvdaSupportsModeHint.textContent = mode === \\\\\\\'price\\\\\\\'\\\\n                    ? \\\\\\\'Below current price (highest Put OI)\\\\\\\'\\\\n                    : \\\\\\\'Below gamma flip (highest Put OI)\\\\\\\';\\\\n            }\\\\n            if (nvdaResistancesModeHint) {\\\\n                nvdaResistancesModeHint.textContent = mode === \\\\\\\'price\\\\\\\'\\\\n                    ? \\\\\\\'Above current price (highest Call OI)\\\\\\\'\\\\n                    : \\\\\\\'Above gamma flip (highest Call OI)\\\\\\\';\\\\n            }\\\\n\\\\n            const supports = Array.isArray(data.supports) ? data.supports : [];\\\\n            const resistances = Array.isArray(data.resistances) ? data.resistances : [];\\\\n\\\\n            if (nvdaSupportsContainer) {\\\\n                if (supports.length > 0) {\\\\n                    nvdaSupportsContainer.innerHTML = supports.map((s, i) => `\\\\n                        <div class="level-item support-item ${heatClassForIndex(i)}" data-strike="${Number(s.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div class="fw-bold text-support">S${i + 1}  ${Number(s.strike).toFixed(2)}</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n\\\\n                    try {\\\\n                        const items = nvdaSupportsContainer.querySelectorAll(\\\\\\\'.level-item\\\\\\\');\\\\n                        items.forEach((el, idx) => {\\\\n                            const s = supports[idx] || {};\\\\n                            setTooltip(el, _formatLevelTooltip(s.call_oi, s.put_oi, s.gamma));\\\\n                        });\\\\n                    } catch (e) {}\\\\n                } else {\\\\n                    nvdaSupportsContainer.innerHTML = `<p class="text-muted text-center py-3">No support below ${mode === \\\\\\\'price\\\\\\\' ? \\\\\\\'price\\\\\\\' : \\\\\\\'gamma flip\\\\\\\'}</p>`;\\\\n                }\\\\n            }\\\\n\\\\n            if (nvdaSupportsNote) {\\\\n                if (data.supports_note) {\\\\n                    nvdaSupportsNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.supports_note;\\\\n                    nvdaSupportsNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    nvdaSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (nvdaResistancesContainer) {\\\\n                if (resistances.length > 0) {\\\\n                    nvdaResistancesContainer.innerHTML = resistances.map((r, i) => `\\\\n                        <div class="level-item resistance-item ${heatClassForIndex(i)}" data-strike="${Number(r.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div class="fw-bold text-resistance">R${i + 1}  ${Number(r.strike).toFixed(2)}</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n\\\\n                    try {\\\\n                        const items = nvdaResistancesContainer.querySelectorAll(\\\\\\\'.level-item\\\\\\\');\\\\n                        items.forEach((el, idx) => {\\\\n                            const r = resistances[idx] || {};\\\\n                            setTooltip(el, _formatLevelTooltip(r.call_oi, r.put_oi, r.gamma));\\\\n                        });\\\\n                    } catch (e) {}\\\\n                } else {\\\\n                    nvdaResistancesContainer.innerHTML = `<p class="text-muted text-center py-3">No resistance above ${mode === \\\\\\\'price\\\\\\\' ? \\\\\\\'price\\\\\\\' : \\\\\\\'gamma flip\\\\\\\'}</p>`;\\\\n                }\\\\n            }\\\\n\\\\n            updateNvdaNearSignals();\\\\n\\\\n            if (nvdaResistancesNote) {\\\\n                if (data.resistances_note) {\\\\n                    nvdaResistancesNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.resistances_note;\\\\n                    nvdaResistancesNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    nvdaResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n        }\\\\n\\\\n        function displaySpyKeyLevels(data) {\\\\n            if (spyExpiryLabel) {\\\\n                if (data && data.expiration) {\\\\n                    spyExpiryLabel.textContent = `(nearest expiry: ${data.expiration})`;\\\\n                } else {\\\\n                    spyExpiryLabel.textContent = \\\\\\\'\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (!data || data.error) {\\\\n                setPutCallRatio(spyPcrLabel, null);\\\\n                if (spySupportsContainer) spySupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (spyResistancesContainer) spyResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (spySupportsNote) spySupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                if (spyResistancesNote) spyResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                return;\\\\n            }\\\\n\\\\n            setPutCallRatio(spyPcrLabel, data.stats);\\\\n\\\\n            const supports = Array.isArray(data.supports) ? data.supports : [];\\\\n            const resistances = Array.isArray(data.resistances) ? data.resistances : [];\\\\n\\\\n            if (spySupportsContainer) {\\\\n                if (supports.length > 0) {\\\\n                    spySupportsContainer.innerHTML = supports.map((s, i) => `\\\\n                        <div class="level-item support-item ${heatClassForIndex(i)}" data-strike="${Number(s.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div>\\\\n                                    <div class="fw-bold text-support fs-5">S${i + 1}  ${Number(s.strike).toFixed(2)}</div>\\\\n                                    <div class="text-muted small">Call: ${Number(s.call_oi).toLocaleString()} | Put: ${Number(s.put_oi).toLocaleString()}</div>\\\\n                                </div>\\\\n                                <div class="fw-bold text-support fs-5 level-metric">+${(Number(s.gamma) / 1000).toFixed(0)}K</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n                } else {\\\\n                    spySupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No support below price</p>\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (spySupportsNote) {\\\\n                if (data.supports_note) {\\\\n                    spySupportsNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.supports_note;\\\\n                    spySupportsNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    spySupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (spyResistancesContainer) {\\\\n                if (resistances.length > 0) {\\\\n                    spyResistancesContainer.innerHTML = resistances.map((r, i) => `\\\\n                        <div class="level-item resistance-item ${heatClassForIndex(i)}" data-strike="${Number(r.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div>\\\\n                                    <div class="fw-bold text-resistance fs-5">R${i + 1}  ${Number(r.strike).toFixed(2)}</div>\\\\n                                    <div class="text-muted small">Call: ${Number(r.call_oi).toLocaleString()} | Put: ${Number(r.put_oi).toLocaleString()}</div>\\\\n                                </div>\\\\n                                <div class="fw-bold text-resistance fs-5 level-metric">${(Number(r.gamma) / 1000).toFixed(0)}K</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n                } else {\\\\n                    spyResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No resistance above price</p>\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (spyResistancesNote) {\\\\n                if (data.resistances_note) {\\\\n                    spyResistancesNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.resistances_note;\\\\n                    spyResistancesNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    spyResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            updateSpyNearSignals();\\\\n        }\\\\n\\\\n        function displayMsftKeyLevels(data) {\\\\n            if (msftExpiryLabel) {\\\\n                if (data && data.expiration) {\\\\n                    msftExpiryLabel.textContent = `(nearest expiry: ${data.expiration})`;\\\\n                } else {\\\\n                    msftExpiryLabel.textContent = \\\\\\\'\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (!data || data.error) {\\\\n                setPutCallRatio(msftPcrLabel, null);\\\\n                if (msftSupportsContainer) msftSupportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (msftResistancesContainer) msftResistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No data</p>\\\\\\\';\\\\n                if (msftSupportsNote) msftSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                if (msftResistancesNote) msftResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                return;\\\\n            }\\\\n\\\\n            setPutCallRatio(msftPcrLabel, data.stats);\\\\n\\\\n            const mode = (data && data.levels_mode ? String(data.levels_mode) : _levelsModeFromSwitch(msftLevelsModeSwitch)).toLowerCase();\\\\n            if (msftSupportsModeHint) {\\\\n                msftSupportsModeHint.textContent = mode === \\\\\\\'price\\\\\\\'\\\\n                    ? \\\\\\\'Below current price (highest Put OI)\\\\\\\'\\\\n                    : \\\\\\\'Below gamma flip (highest Put OI)\\\\\\\';\\\\n            }\\\\n            if (msftResistancesModeHint) {\\\\n                msftResistancesModeHint.textContent = mode === \\\\\\\'price\\\\\\\'\\\\n                    ? \\\\\\\'Above current price (highest Call OI)\\\\\\\'\\\\n                    : \\\\\\\'Above gamma flip (highest Call OI)\\\\\\\';\\\\n            }\\\\n\\\\n            const supports = Array.isArray(data.supports) ? data.supports : [];\\\\n            const resistances = Array.isArray(data.resistances) ? data.resistances : [];\\\\n\\\\n            if (msftSupportsContainer) {\\\\n                if (supports.length > 0) {\\\\n                    msftSupportsContainer.innerHTML = supports.map((s, i) => `\\\\n                        <div class="level-item support-item ${heatClassForIndex(i)}" data-strike="${Number(s.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div class="fw-bold text-support">S${i + 1}  ${Number(s.strike).toFixed(2)}</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n\\\\n                    try {\\\\n                        const items = msftSupportsContainer.querySelectorAll(\\\\\\\'.level-item\\\\\\\');\\\\n                        items.forEach((el, idx) => {\\\\n                            const s = supports[idx] || {};\\\\n                            setTooltip(el, _formatLevelTooltip(s.call_oi, s.put_oi, s.gamma));\\\\n                        });\\\\n                    } catch (e) {}\\\\n                } else {\\\\n                    msftSupportsContainer.innerHTML = `<p class="text-muted text-center py-3">No support below ${mode === \\\\\\\'price\\\\\\\' ? \\\\\\\'price\\\\\\\' : \\\\\\\'gamma flip\\\\\\\'}</p>`;\\\\n                }\\\\n            }\\\\n\\\\n            if (msftSupportsNote) {\\\\n                if (data.supports_note) {\\\\n                    msftSupportsNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.supports_note;\\\\n                    msftSupportsNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    msftSupportsNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            if (msftResistancesContainer) {\\\\n                if (resistances.length > 0) {\\\\n                    msftResistancesContainer.innerHTML = resistances.map((r, i) => `\\\\n                        <div class="level-item resistance-item ${heatClassForIndex(i)}" data-strike="${Number(r.strike)}">\\\\n                            <div class="d-flex justify-content-between align-items-center level-row">\\\\n                                <div class="fw-bold text-resistance">R${i + 1}  ${Number(r.strike).toFixed(2)}</div>\\\\n                            </div>\\\\n                        </div>\\\\n                    `).join(\\\\\\\'\\\\\\\');\\\\n\\\\n                    try {\\\\n                        const items = msftResistancesContainer.querySelectorAll(\\\\\\\'.level-item\\\\\\\');\\\\n                        items.forEach((el, idx) => {\\\\n                            const r = resistances[idx] || {};\\\\n                            setTooltip(el, _formatLevelTooltip(r.call_oi, r.put_oi, r.gamma));\\\\n                        });\\\\n                    } catch (e) {}\\\\n                } else {\\\\n                    msftResistancesContainer.innerHTML = `<p class="text-muted text-center py-3">No resistance above ${mode === \\\\\\\'price\\\\\\\' ? \\\\\\\'price\\\\\\\' : \\\\\\\'gamma flip\\\\\\\'}</p>`;\\\\n                }\\\\n            }\\\\n\\\\n            if (msftResistancesNote) {\\\\n                if (data.resistances_note) {\\\\n                    msftResistancesNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.resistances_note;\\\\n                    msftResistancesNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                } else {\\\\n                    msftResistancesNote.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n\\\\n            updateMsftNearSignals();\\\\n        }\\\\n\\\\n        async function loadAaplSnapshot() {\\\\n            if (aaplLoadPromise) return aaplLoadPromise;\\\\n\\\\n            aaplLoadPromise = (async () => {\\\\n                try {\\\\n                    const response = await fetch(\\\\\\\'/api/aapl-snapshot\\\\\\\');\\\\n                    const data = await response.json();\\\\n                    if (!response.ok || data.error) throw new Error(data.error || \\\\\\\'AAPL fetch failed\\\\\\\');\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestAaplPrice != null) prevAaplPrice = latestAaplPrice;\\\\n                        latestAaplPrice = price;\\\\n                    } else {\\\\n                        latestAaplPrice = null;\\\\n                    }\\\\n                    latestAaplGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    updatePressureUI();\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    latestAaplPrice = null;\\\\n                    latestAaplGammaFlip = null;\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return aaplLoadPromise;\\\\n        }\\\\n\\\\n        async function refreshAaplSnapshot() {\\\\n            aaplLoadPromise = null;\\\\n            return loadAaplSnapshot();\\\\n        }\\\\n\\\\n        function startAaplPolling() {\\\\n            if (aaplPollIntervalId) return;\\\\n            refreshAaplSnapshot();\\\\n            aaplPollIntervalId = setInterval(refreshAaplSnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopAaplPolling() {\\\\n            if (!aaplPollIntervalId) return;\\\\n            clearInterval(aaplPollIntervalId);\\\\n            aaplPollIntervalId = null;\\\\n        }\\\\n\\\\n        async function loadGoogSnapshot() {\\\\n            if (googLoadPromise) return googLoadPromise;\\\\n\\\\n            googLoadPromise = (async () => {\\\\n                try {\\\\n                    const response = await fetch(\\\\\\\'/api/goog-snapshot\\\\\\\');\\\\n                    const data = await response.json();\\\\n                    if (!response.ok || data.error) throw new Error(data.error || \\\\\\\'GOOG fetch failed\\\\\\\');\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestGoogPrice != null) prevGoogPrice = latestGoogPrice;\\\\n                        latestGoogPrice = price;\\\\n                    } else {\\\\n                        latestGoogPrice = null;\\\\n                    }\\\\n                    latestGoogGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    updatePressureUI();\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    latestGoogPrice = null;\\\\n                    latestGoogGammaFlip = null;\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return googLoadPromise;\\\\n        }\\\\n\\\\n        async function refreshGoogSnapshot() {\\\\n            googLoadPromise = null;\\\\n            return loadGoogSnapshot();\\\\n        }\\\\n\\\\n        function startGoogPolling() {\\\\n            if (googPollIntervalId) return;\\\\n            refreshGoogSnapshot();\\\\n            googPollIntervalId = setInterval(refreshGoogSnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopGoogPolling() {\\\\n            if (!googPollIntervalId) return;\\\\n            clearInterval(googPollIntervalId);\\\\n            googPollIntervalId = null;\\\\n        }\\\\n\\\\n        async function loadAmznSnapshot() {\\\\n            if (amznLoadPromise) return amznLoadPromise;\\\\n\\\\n            amznLoadPromise = (async () => {\\\\n                try {\\\\n                    const response = await fetch(\\\\\\\'/api/amzn-snapshot\\\\\\\');\\\\n                    const data = await response.json();\\\\n                    if (!response.ok || data.error) throw new Error(data.error || \\\\\\\'AMZN fetch failed\\\\\\\');\\\\n\\\\n                    const price = Number(data.price);\\\\n                    const gammaFlip = Number(data.gamma_flip);\\\\n\\\\n                    if (Number.isFinite(price)) {\\\\n                        if (latestAmznPrice != null) prevAmznPrice = latestAmznPrice;\\\\n                        latestAmznPrice = price;\\\\n                    } else {\\\\n                        latestAmznPrice = null;\\\\n                    }\\\\n                    latestAmznGammaFlip = Number.isFinite(gammaFlip) ? gammaFlip : null;\\\\n\\\\n                    updatePressureUI();\\\\n                    return data;\\\\n                } catch (e) {\\\\n                    latestAmznPrice = null;\\\\n                    latestAmznGammaFlip = null;\\\\n                    updatePressureUI();\\\\n                    return null;\\\\n                }\\\\n            })();\\\\n\\\\n            return amznLoadPromise;\\\\n        }\\\\n\\\\n        async function refreshAmznSnapshot() {\\\\n            amznLoadPromise = null;\\\\n            return loadAmznSnapshot();\\\\n        }\\\\n\\\\n        function startAmznPolling() {\\\\n            if (amznPollIntervalId) return;\\\\n            refreshAmznSnapshot();\\\\n            amznPollIntervalId = setInterval(refreshAmznSnapshot, 60000);\\\\n        }\\\\n\\\\n        function stopAmznPolling() {\\\\n            if (!amznPollIntervalId) return;\\\\n            clearInterval(amznPollIntervalId);\\\\n            amznPollIntervalId = null;\\\\n        }\\\\n\\\\n        document.addEventListener(\\\\\\\'visibilitychange\\\\\\\', () => {\\\\n            if (document.hidden) {\\\\n                stopEsPricePolling();\\\\n                stopNvdaPolling();\\\\n                stopSpyPolling();\\\\n                stopMsftPolling();\\\\n                stopSpxPolling();\\\\n                stopXspPolling();\\\\n                stopAaplPolling();\\\\n                stopGoogPolling();\\\\n                stopAmznPolling();\\\\n            } else {\\\\n                startEsPricePolling();\\\\n                startNvdaPolling();\\\\n                startSpyPolling();\\\\n                startMsftPolling();\\\\n                startSpxPolling();\\\\n                startXspPolling();\\\\n                startAaplPolling();\\\\n                startGoogPolling();\\\\n                startAmznPolling();\\\\n            }\\\\n        });\\\\n\\\\n        // Kick off price fetch on page load.\\\\n        startEsPricePolling();\\\\n        startNvdaPolling();\\\\n        startSpxPolling();\\\\n        startSpyPolling();\\\\n        startXspPolling();\\\\n        startMsftPolling();\\\\n        startAaplPolling();\\\\n        startGoogPolling();\\\\n        startAmznPolling();\\\\n\\\\n        async function runAnalysis() {\\\\n            if (!selectedFile || isAnalyzing) return;\\\\n\\\\n            isAnalyzing = true;\\\\n\\\\n            const regimeCard = document.getElementById(\\\\\\\'regimeCard\\\\\\\');\\\\n            if (regimeCard) regimeCard.style.display = \\\\\\\'none\\\\\\\';\\\\n\\\\n            const formData = new FormData();\\\\n            formData.append(\\\\\\\'file\\\\\\\', selectedFile);\\\\n\\\\n            if (Number.isFinite(latestEsPrice)) {\\\\n                formData.append(\\\\\\\'current_price\\\\\\\', String(latestEsPrice));\\\\n            }\\\\n\\\\n            if (esLevelsModeSwitch) {\\\\n                formData.append(\\\\\\\'levels_mode\\\\\\\', esLevelsModeSwitch.checked ? \\\\\\\'price\\\\\\\' : \\\\\\\'flip\\\\\\\');\\\\n                try {\\\\n                    localStorage.setItem(\\\\\\\'es_levels_mode\\\\\\\', esLevelsModeSwitch.checked ? \\\\\\\'price\\\\\\\' : \\\\\\\'flip\\\\\\\');\\\\n                } catch (e) {\\\\n                    // ignore\\\\n                }\\\\n            }\\\\n\\\\n            loading.style.display = \\\\\\\'block\\\\\\\';\\\\n            results.style.display = \\\\\\\'none\\\\\\\';\\\\n            errorMsg.style.display = \\\\\\\'none\\\\\\\';\\\\n            analyzeBtn.disabled = true;\\\\n\\\\n            try {\\\\n                const response = await fetch(\\\\\\\'/analyze\\\\\\\', {\\\\n                    method: \\\\\\\'POST\\\\\\\',\\\\n                    body: formData\\\\n                });\\\\n\\\\n                const data = await response.json();\\\\n\\\\n                if (data.error) {\\\\n                    let details = \\\\\\\'\\\\\\\';\\\\n                    if (Array.isArray(data.extraction_attempts) && data.extraction_attempts.length > 0) {\\\\n                        const lines = data.extraction_attempts\\\\n                            .map(a => `${a.label}: ${a.rows} rows (${a.seconds}s)`)\\\\n                            .join(\\\\\\\'<br>\\\\\\\');\\\\n                        const pym = (data.pymupdf_available === false) ? \\\\\\\'no\\\\\\\' : \\\\\\\'yes\\\\\\\';\\\\n                        details = `<div class="mt-2 small text-muted">PyMuPDF: ${pym}<br>${lines}</div>`;\\\\n                    }\\\\n                    errorMsg.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.error + details;\\\\n                    errorMsg.style.display = \\\\\\\'block\\\\\\\';\\\\n                    return;\\\\n                }\\\\n\\\\n                displayResults(data);\\\\n                results.style.display = \\\\\\\'block\\\\\\\';\\\\n\\\\n            } catch (error) {\\\\n                errorMsg.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + (error && error.message ? error.message : String(error));\\\\n                errorMsg.style.display = \\\\\\\'block\\\\\\\';\\\\n            } finally {\\\\n                loading.style.display = \\\\\\\'none\\\\\\\';\\\\n                analyzeBtn.disabled = false;\\\\n                isAnalyzing = false;\\\\n            }\\\\n        }\\\\n        \\\\n        uploadArea.addEventListener(\\\\\\\'click\\\\\\\', () => fileInput.click());\\\\n        \\\\n        fileInput.addEventListener(\\\\\\\'change\\\\\\\', async (e) => {\\\\n            selectedFile = e.target.files[0];\\\\n            if (selectedFile) {\\\\n                uploadArea.innerHTML = `\\\\n                    <div class="d-flex align-items-center flex-wrap">\\\\n                        <i class="bi bi-check-circle me-3" style="font-size: 2.5rem; color: #2dd4bf;"></i>\\\\n                        <div class="min-w-0">\\\\n                            <h6 class="mb-1 text-truncate d-block filename-truncate">${selectedFile.name}</h6>\\\\n                            <p class="text-muted small mb-0">Click to change</p>\\\\n                        </div>\\\\n                    </div>\\\\n                `;\\\\n                analyzeBtn.disabled = false;\\\\n\\\\n                await refreshEsPrice();\\\\n                await runAnalysis();\\\\n            }\\\\n        });\\\\n\\\\n        if (esLevelsModeSwitch) {\\\\n            // Restore last choice\\\\n            try {\\\\n                const saved = (localStorage.getItem(\\\\\\\'es_levels_mode\\\\\\\') || \\\\\\\'price\\\\\\\').toLowerCase();\\\\n                esLevelsModeSwitch.checked = saved === \\\\\\\'price\\\\\\\';\\\\n            } catch (e) {\\\\n                // ignore\\\\n            }\\\\n\\\\n            esLevelsModeSwitch.addEventListener(\\\\\\\'change\\\\\\\', async () => {\\\\n                // Re-run analysis with the same uploaded PDF so you can compare quickly.\\\\n                if (!selectedFile) return;\\\\n                await runAnalysis();\\\\n            });\\\\n        }\\\\n\\\\n        _restoreLevelsModeSwitch(nvdaLevelsModeSwitch, \\\\\\\'nvda_levels_mode\\\\\\\');\\\\n        _restoreLevelsModeSwitch(msftLevelsModeSwitch, \\\\\\\'msft_levels_mode\\\\\\\');\\\\n\\\\n        if (nvdaLevelsModeSwitch) {\\\\n            nvdaLevelsModeSwitch.addEventListener(\\\\\\\'change\\\\\\\', async () => {\\\\n                _persistLevelsModeSwitch(nvdaLevelsModeSwitch, \\\\\\\'nvda_levels_mode\\\\\\\');\\\\n                await refreshNvdaSnapshot();\\\\n            });\\\\n        }\\\\n\\\\n        if (msftLevelsModeSwitch) {\\\\n            msftLevelsModeSwitch.addEventListener(\\\\\\\'change\\\\\\\', async () => {\\\\n                _persistLevelsModeSwitch(msftLevelsModeSwitch, \\\\\\\'msft_levels_mode\\\\\\\');\\\\n                await refreshMsftSnapshot();\\\\n            });\\\\n        }\\\\n        \\\\n        uploadArea.addEventListener(\\\\\\\'dragover\\\\\\\', (e) => {\\\\n            e.preventDefault();\\\\n            uploadArea.classList.add(\\\\\\\'dragover\\\\\\\');\\\\n        });\\\\n        \\\\n        uploadArea.addEventListener(\\\\\\\'dragleave\\\\\\\', () => {\\\\n            uploadArea.classList.remove(\\\\\\\'dragover\\\\\\\');\\\\n        });\\\\n        \\\\n        uploadArea.addEventListener(\\\\\\\'drop\\\\\\\', async (e) => {\\\\n            e.preventDefault();\\\\n            uploadArea.classList.remove(\\\\\\\'dragover\\\\\\\');\\\\n            \\\\n            const files = e.dataTransfer.files;\\\\n            if (files.length > 0) {\\\\n                selectedFile = files[0];\\\\n                fileInput.files = files;\\\\n                uploadArea.innerHTML = `\\\\n                    <div class="d-flex align-items-center flex-wrap">\\\\n                        <i class="bi bi-check-circle me-3" style="font-size: 2.5rem; color: #2dd4bf;"></i>\\\\n                        <div class="min-w-0">\\\\n                            <h6 class="mb-1 text-truncate d-block filename-truncate">${selectedFile.name}</h6>\\\\n                            <p class="text-muted small mb-0">Click to change</p>\\\\n                        </div>\\\\n                    </div>\\\\n                `;\\\\n                analyzeBtn.disabled = false;\\\\n\\\\n                await refreshEsPrice();\\\\n                await runAnalysis();\\\\n            }\\\\n        });\\\\n        \\\\n        analyzeBtn.addEventListener(\\\\\\\'click\\\\\\\', runAnalysis);\\\\n        \\\\n        function displayResults(data) {\\\\n            setPutCallRatio(esPcrLabel, data && data.stats ? data.stats : null);\\\\n\\\\n            // Update hint text to reflect the selected basis.\\\\n            const mode = (data && data.levels_mode ? String(data.levels_mode) : \\\\\\\'flip\\\\\\\').toLowerCase();\\\\n            if (esSupportsModeHint) {\\\\n                esSupportsModeHint.textContent = mode === \\\\\\\'price\\\\\\\'\\\\n                    ? \\\\\\\'Below current price (highest Put OI)\\\\\\\'\\\\n                    : \\\\\\\'Below gamma flip (highest Put OI)\\\\\\\';\\\\n            }\\\\n            if (esResistancesModeHint) {\\\\n                esResistancesModeHint.textContent = mode === \\\\\\\'price\\\\\\\'\\\\n                    ? \\\\\\\'Above current price (highest Call OI)\\\\\\\'\\\\n                    : \\\\\\\'Above gamma flip (highest Call OI)\\\\\\\';\\\\n            }\\\\n\\\\n            // Gamma Flip\\\\n            const gammaFlipValueEl = document.getElementById(\\\\\\\'gammaFlipValue\\\\\\\');\\\\n            if (gammaFlipValueEl) {\\\\n                gammaFlipValueEl.textContent = data.gamma_flip ? data.gamma_flip.toFixed(2) : \\\\\\\'N/A\\\\\\\';\\\\n            }\\\\n\\\\n            if (gammaFlipTop) {\\\\n                gammaFlipTop.textContent = data.gamma_flip ? data.gamma_flip.toFixed(2) : \\\\\\\'--\\\\\\\';\\\\n            }\\\\n\\\\n            setTooltip(\\\\n                gammaFlipBox,\\\\n                `Gamma Flip: ${data && data.gamma_flip ? Number(data.gamma_flip).toFixed(2) : \\\\\\\'--\\\\\\\'}${data && data.regime ? `\\\\\\\\nRegime: ${data.regime}` : \\\\\\\'\\\\\\\'}`\\\\n            );\\\\n\\\\n            latestEsGammaFlip = (data && Number.isFinite(Number(data.gamma_flip))) ? Number(data.gamma_flip) : null;\\\\n            \\\\n            // Regime\\\\n            const regimeCard = document.getElementById(\\\\\\\'regimeCard\\\\\\\');\\\\n            if (regimeCard) {\\\\n                if (data.regime) {\\\\n                    regimeCard.style.display = \\\\\\\'block\\\\\\\';\\\\n                    document.getElementById(\\\\\\\'regimeType\\\\\\\').textContent = data.regime;\\\\n                    document.getElementById(\\\\\\\'regimeStrategy\\\\\\\').innerHTML = \\\\\\\'<i class="bi bi-info-circle me-2"></i>\\\\\\\' + data.strategy;\\\\n                } else {\\\\n                    regimeCard.style.display = \\\\\\\'none\\\\\\\';\\\\n                }\\\\n            }\\\\n            \\\\n            // Supporti\\\\n            const supportsContainer = document.getElementById(\\\\\\\'supportsContainer\\\\\\\');\\\\n            const supportsNote = document.getElementById(\\\\\\\'supportsNote\\\\\\\');\\\\n            if (data.supports && data.supports.length > 0) {\\\\n                supportsContainer.innerHTML = data.supports.map((s, i) => `\\\\n                    <div class="level-item support-item ${heatClassForIndex(i)}" data-strike="${Number(s.strike)}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Call: ${Number(s.call_oi).toLocaleString()} | Put: ${Number(s.put_oi).toLocaleString()} | Gamma: ${(Number(s.gamma) / 1000).toFixed(0)}K">\\\\n                        <div class="d-flex justify-content-between align-items-center level-row">\\\\n                            <div class="fw-bold text-support">S${i+1}  ${Number(s.strike).toFixed(2)}</div>\\\\n                        </div>\\\\n                    </div>\\\\n                `).join(\\\\\\\'\\\\\\\');\\\\n\\\\n                initTooltipsWithin(supportsContainer);\\\\n                \\\\n                if (data.supports_note) {\\\\n                    supportsNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.supports_note;\\\\n                    supportsNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                }\\\\n            } else {\\\\n                supportsContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No support below price</p>\\\\\\\';\\\\n            }\\\\n            \\\\n            // Resistenze\\\\n            const resistancesContainer = document.getElementById(\\\\\\\'resistancesContainer\\\\\\\');\\\\n            const resistancesNote = document.getElementById(\\\\\\\'resistancesNote\\\\\\\');\\\\n            if (data.resistances && data.resistances.length > 0) {\\\\n                resistancesContainer.innerHTML = data.resistances.map((r, i) => `\\\\n                    <div class="level-item resistance-item ${heatClassForIndex(i)}" data-strike="${Number(r.strike)}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Call: ${Number(r.call_oi).toLocaleString()} | Put: ${Number(r.put_oi).toLocaleString()} | Gamma: ${(Number(r.gamma) / 1000).toFixed(0)}K">\\\\n                        <div class="d-flex justify-content-between align-items-center level-row">\\\\n                            <div class="fw-bold text-resistance">R${i+1}  ${Number(r.strike).toFixed(2)}</div>\\\\n                        </div>\\\\n                    </div>\\\\n                `).join(\\\\\\\'\\\\\\\');\\\\n\\\\n                initTooltipsWithin(resistancesContainer);\\\\n                \\\\n                if (data.resistances_note) {\\\\n                    resistancesNote.innerHTML = \\\\\\\'<i class="bi bi-exclamation-triangle me-2"></i>\\\\\\\' + data.resistances_note;\\\\n                    resistancesNote.style.display = \\\\\\\'block\\\\\\\';\\\\n                }\\\\n            } else {\\\\n                resistancesContainer.innerHTML = \\\\\\\'<p class="text-muted text-center py-3">No resistance above price</p>\\\\\\\';\\\\n            }\\\\n            \\\\n            // Statistiche (removed)\\\\n\\\\n            updateEsNearSignals();\\\\n            updatePressureUI();\\\\n            \\\\n            // Initialize chart\\\\n            // createChart(data);\\\\n        }\\\\n        \\\\n        function createChart(data) {\\\\n            const chartContainer = document.getElementById(\\\\\\\'chart\\\\\\\');\\\\n            if (!chartContainer) {\\\\n                console.error(\\\\\\\'Chart container not found\\\\\\\');\\\\n                return;\\\\n            }\\\\n            \\\\n            chartContainer.innerHTML = \\\\\\\'\\\\\\\'; // Clear previous chart\\\\n            \\\\n            // Check if LightweightCharts is loaded\\\\n            if (typeof LightweightCharts === \\\\\\\'undefined\\\\\\\') {\\\\n                console.error(\\\\\\\'LightweightCharts not loaded\\\\\\\');\\\\n                chartContainer.innerHTML = \\\\\\\'<div class="alert alert-warning">Chart library not loaded. Please refresh the page.</div>\\\\\\\';\\\\n                return;\\\\n            }\\\\n            \\\\n            const chart = LightweightCharts.createChart(chartContainer, {\\\\n                width: chartContainer.offsetWidth,\\\\n                height: 500,\\\\n                layout: {\\\\n                    background: { type: \\\\\\\'solid\\\\\\\', color: \\\\\\\'#ffffff\\\\\\\' },\\\\n                    textColor: \\\\\\\'#333\\\\\\\',\\\\n                },\\\\n                grid: {\\\\n                    vertLines: { color: \\\\\\\'#e1e1e1\\\\\\\' },\\\\n                    horzLines: { color: \\\\\\\'#e1e1e1\\\\\\\' },\\\\n                },\\\\n                rightPriceScale: {\\\\n                    borderColor: \\\\\\\'#cccccc\\\\\\\',\\\\n                },\\\\n                timeScale: {\\\\n                    borderColor: \\\\\\\'#cccccc\\\\\\\',\\\\n                    timeVisible: true,\\\\n                    secondsVisible: false,\\\\n                },\\\\n            });\\\\n            \\\\n            // Create candlestick series (mock data for visualization)\\\\n            const candlestickSeries = chart.addCandlestickSeries({\\\\n                upColor: \\\\\\\'#2dd4bf\\\\\\\',\\\\n                downColor: \\\\\\\'#fb7185\\\\\\\',\\\\n                borderVisible: false,\\\\n                wickUpColor: \\\\\\\'#2dd4bf\\\\\\\',\\\\n                wickDownColor: \\\\\\\'#fb7185\\\\\\\',\\\\n            });\\\\n            \\\\n            // Generate mock price data around current price\\\\n            const currentPrice = parseFloat(data.current_price || data.gamma_flip || 6900);\\\\n            const mockData = [];\\\\n            \\\\n            // Use simple date string format YYYY-MM-DD\\\\n            const baseDate = new Date();\\\\n            baseDate.setHours(9, 30, 0, 0); // Start at market open\\\\n            \\\\n            for (let i = 0; i <= 100; i++) {\\\\n                const date = new Date(baseDate);\\\\n                date.setMinutes(baseDate.getMinutes() + (i * 5)); // 5 min intervals forward\\\\n                \\\\n                const dateStr = date.getFullYear() + \\\\\\\'-\\\\\\\' + \\\\n                              String(date.getMonth() + 1).padStart(2, \\\\\\\'0\\\\\\\') + \\\\\\\'-\\\\\\\' + \\\\n                              String(date.getDate()).padStart(2, \\\\\\\'0\\\\\\\');\\\\n                \\\\n                const basePrice = currentPrice;\\\\n                const variation = (Math.random() - 0.5) * 20;\\\\n                const open = basePrice + variation;\\\\n                const close = basePrice + (Math.random() - 0.5) * 15;\\\\n                const high = Math.max(open, close) + Math.random() * 5;\\\\n                const low = Math.min(open, close) - Math.random() * 5;\\\\n                \\\\n                mockData.push({\\\\n                    time: dateStr,\\\\n                    open: parseFloat(open.toFixed(2)),\\\\n                    high: parseFloat(high.toFixed(2)),\\\\n                    low: parseFloat(low.toFixed(2)),\\\\n                    close: parseFloat(close.toFixed(2)),\\\\n                });\\\\n            }\\\\n            \\\\n            console.log(\\\\\\\'Chart data sample:\\\\\\\', mockData.slice(0, 3));\\\\n            try {\\\\n                candlestickSeries.setData(mockData);\\\\n            } catch (e) {\\\\n                console.error(\\\\\\\'Error setting chart data:\\\\\\\', e);\\\\n            }\\\\n            \\\\n            // Plot resistance levels (from supports in data)\\\\n            if (data.supports && data.supports.length > 0) {\\\\n                data.supports.forEach((level, i) => {\\\\n                    const priceLine = candlestickSeries.createPriceLine({\\\\n                        price: level.strike,\\\\n                        color: \\\\\\\'#2dd4bf\\\\\\\',\\\\n                        lineWidth: 2,\\\\n                        lineStyle: LightweightCharts.LineStyle.Solid,\\\\n                        axisLabelVisible: true,\\\\n                        title: `R${i+1} ${level.strike.toFixed(2)}`,\\\\n                    });\\\\n                });\\\\n            }\\\\n            \\\\n            // Plot support levels (from resistances in data)\\\\n            if (data.resistances && data.resistances.length > 0) {\\\\n                data.resistances.forEach((level, i) => {\\\\n                    const priceLine = candlestickSeries.createPriceLine({\\\\n                        price: level.strike,\\\\n                        color: \\\\\\\'#fb7185\\\\\\\',\\\\n                        lineWidth: 2,\\\\n                        lineStyle: LightweightCharts.LineStyle.Solid,\\\\n                        axisLabelVisible: true,\\\\n                        title: `S${i+1} ${level.strike.toFixed(2)}`,\\\\n                    });\\\\n                });\\\\n            }\\\\n            \\\\n            // Plot gamma flip level\\\\n            if (data.gamma_flip) {\\\\n                const gammaLine = candlestickSeries.createPriceLine({\\\\n                    price: data.gamma_flip,\\\\n                    color: \\\\\\\'#778da9\\\\\\\',\\\\n                    lineWidth: 3,\\\\n                    lineStyle: LightweightCharts.LineStyle.Dashed,\\\\n                    axisLabelVisible: true,\\\\n                    title: `Gamma Flip ${data.gamma_flip.toFixed(2)}`,\\\\n                });\\\\n            }\\\\n            \\\\n            // Plot current price line\\\\n            if (data.current_price) {\\\\n                const currentLine = candlestickSeries.createPriceLine({\\\\n                    price: data.current_price,\\\\n                    color: \\\\\\\'#415a77\\\\\\\',\\\\n                    lineWidth: 2,\\\\n                    lineStyle: LightweightCharts.LineStyle.Dotted,\\\\n                    axisLabelVisible: true,\\\\n                    title: `Current ${data.current_price}`,\\\\n                });\\\\n            }\\\\n            \\\\n            // Fit content to show all levels\\\\n            chart.timeScale().fitContent();\\\\n            \\\\n            // Handle window resize\\\\n            window.addEventListener(\\\\\\\'resize\\\\\\\', () => {\\\\n                chart.applyOptions({ width: chartContainer.offsetWidth });\\\\n            });\\\\n        }\\\\n    </script>\\\\n</body>\\\\n</html>\\\'\\n\\nblocks = {}\\ndebug_info = \\\'568=14&569=18&572=21&575=23&578=26\\\'\'\n\nblocks = {}\ndebug_info = \'\''

blocks = {}
debug_info = ''